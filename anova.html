<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Unidad 3 Modelo de ANOVA | Una primera aproximación a la Estadística Bayesiana</title>
<meta name="description" content="3.1 Introducción El modelo de ANOVA se plantea para comparar poblaciones normales, especialmente cuando son más de dos las poblaciones a comparar. Las poblaciones a comparar se identifican a...">
<meta name="generator" content="bookdown 0.28 with bs4_book()">
<meta property="og:title" content="Unidad 3 Modelo de ANOVA | Una primera aproximación a la Estadística Bayesiana">
<meta property="og:type" content="book">
<meta property="og:description" content="3.1 Introducción El modelo de ANOVA se plantea para comparar poblaciones normales, especialmente cuando son más de dos las poblaciones a comparar. Las poblaciones a comparar se identifican a...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Unidad 3 Modelo de ANOVA | Una primera aproximación a la Estadística Bayesiana">
<meta name="twitter:description" content="3.1 Introducción El modelo de ANOVA se plantea para comparar poblaciones normales, especialmente cuando son más de dos las poblaciones a comparar. Las poblaciones a comparar se identifican a...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.4.0/transition.js"></script><script src="libs/bs3compat-0.4.0/tabs.js"></script><script src="libs/bs3compat-0.4.0/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<link rel="stylesheet" href="bs4_style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Una primera aproximación a la Estadística Bayesiana</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html"><span class="header-section-number">1</span> Contexto</a></li>
<li><a class="" href="inlabasics.html"><span class="header-section-number">2</span> Regresión lineal</a></li>
<li><a class="active" href="anova.html"><span class="header-section-number">3</span> Modelo de ANOVA</a></li>
<li><a class="" href="glm.html"><span class="header-section-number">4</span> Modelos lineales generalizados</a></li>
<li><a class="" href="referencias.html">Referencias</a></li>
</ul>

        <div class="book-extra">
          
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="anova" class="section level1" number="3">
<h1>
<span class="header-section-number">Unidad 3</span> Modelo de ANOVA<a class="anchor" aria-label="anchor" href="#anova"><i class="fas fa-link"></i></a>
</h1>
<div id="introducción-1" class="section level2" number="3.1">
<h2>
<span class="header-section-number">3.1</span> Introducción<a class="anchor" aria-label="anchor" href="#introducci%C3%B3n-1"><i class="fas fa-link"></i></a>
</h2>
<p>El modelo de ANOVA se plantea para comparar poblaciones normales, especialmente cuando son más de dos las poblaciones a comparar. Las poblaciones a comparar se identifican a través de una variable clasificadora (de tipo categórico) que actúa como predictora para estimar respuestas medias supuestamente distintas a comparar.</p>
</div>
<div id="el-modelo-de-anova" class="section level2" number="3.2">
<h2>
<span class="header-section-number">3.2</span> El modelo de ANOVA<a class="anchor" aria-label="anchor" href="#el-modelo-de-anova"><i class="fas fa-link"></i></a>
</h2>
<p>Consideremos una variable respuesta <span class="math inline">\(Y\)</span> que se distribuye normal, y que viene afectada por una variable de clasificación <span class="math inline">\(A\)</span> con <span class="math inline">\(a\)</span> niveles de respuesta distintos (uno por cada una de las poblaciones a comparar). Supongamos que tenemos <span class="math inline">\(n_i\)</span> observaciones de la respuesta para cada uno de los niveles de respuesta de la variable clasificadora, <span class="math inline">\(i=1,...,a\)</span>. El modelo de ANOVA se plantea asumiendo que en cada nivel o subpoblación, esperamos una valor distinto para la respuesta,
<span class="math display">\[(y_{ij}|\mu_i,\sigma^2) \sim N(\mu_i,\sigma^2)\]</span>
de modo que
<span class="math display">\[E(y_{ij}|\mu_i,\sigma^2)=\mu_i; \ Var(y_{ij}|\mu_i,\sigma^2)=\sigma^2, \ \ i=1,...,a; \ j=1,...,n_i\]</span>
La formulación habitual de este modelo se suele dar en términos de un efecto global y común a todas las observaciones, <span class="math inline">\(\theta\)</span>, y un efecto diferencial respecto del primer nivel del factor de clasificación <span class="math inline">\(A\)</span>, <span class="math inline">\(\alpha_i\)</span>, con los que se construye la media (identificada generalmente por <span class="math inline">\(\mu\)</span>) o predictor lineal (identificada generalmente por <span class="math inline">\(\eta\)</span>) y que en el modelo lineal coinciden:
<span class="math display">\[\mu_{ij}=\eta_{ij}=\theta + \alpha_i\]</span>
donde <span class="math inline">\(\alpha_i=E(y_{ij}|\mu,\sigma^2)-E(y_{1j}|\mu,\sigma^2), i\geq 1\)</span>, esto es, <span class="math inline">\(\alpha=1=0\)</span>.</p>
<p>En la modelización bayesiana es preciso añadir distribuciones a priori para cada uno de los parámetros del modelo: los efectos fijos <span class="math inline">\(\theta,\alpha_i\)</span>, y la varianza <span class="math inline">\(\sigma^2\)</span> de los datos. Ante ausencia de información, se asumirán distribuciones difusas:</p>
<p><span class="math display">\[\begin{eqnarray*}
(Y_{ij}|\mu_i,\sigma^2) &amp; \sim &amp; N(\mu_i,\sigma^2) \\
&amp;&amp; \mu_i = \theta + \alpha_i, i=1,...,a \\
\theta &amp; \sim &amp; N(0,\sigma_{\theta}^2), \ \sigma_{\theta}^2=0 \\
\alpha_i &amp; \sim &amp; N(0,1000), i\geq 1\\
\tau=1/\sigma^2 &amp; \sim &amp; Ga(1,0.00005)
\end{eqnarray*}\]</span></p>
</div>
<div id="anova-de-una-vía" class="section level2" number="3.3">
<h2>
<span class="header-section-number">3.3</span> Anova de una vía<a class="anchor" aria-label="anchor" href="#anova-de-una-v%C3%ADa"><i class="fas fa-link"></i></a>
</h2>
<p>Vamos a ilustrar el análisis ANOVA en INLA a través de la base de datos <code>coagulation</code>, en la librería <a href="https://cran.r-project.org/web/packages/faraway/faraway.pdf"><code>faraway</code></a>, referidos a un estudio de tiempos de coagulación de la sangre en 24 animales a los que aleatoriamente se les asignó una de entre tres dietas distintas (variable clasificadora <code>diet</code>). Posteriormente, para estudiar el efecto de dichas dietas en la coagulación, se tomaron muestras de los tiempos de coagulación (en la variable <code>coag</code>, que es la respuesta).</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">coagulation</span>, package<span class="op">=</span><span class="st">"faraway"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">coagulation</span><span class="op">)</span></span>
<span><span class="co">#&gt; 'data.frame':    24 obs. of  2 variables:</span></span>
<span><span class="co">#&gt;  $ coag: num  62 60 63 59 63 67 71 64 65 66 ...</span></span>
<span><span class="co">#&gt;  $ diet: Factor w/ 4 levels "A","B","C","D": 1 1 1 1 2 2 2 2 2 2 ...</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">coagulation</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">diet</span>,y<span class="op">=</span><span class="va">coag</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="02-anova_files/figure-html/unnamed-chunk-2-1.png" width="672"></div>
<p>Estamos planteando un modelo de Anova como el propuesto en la sección anterior, donde <span class="math inline">\(\alpha_i\)</span> identifica el efecto diferencial sobre la respuesta con la dieta A, para el resto de las dietas B y C. Los parámetros del modelo son, como en regresión, los efectos fijos <span class="math inline">\((\theta,\alpha_i)\)</span> y la varianza <span class="math inline">\(\sigma^2\)</span>, para los que asumimos las priors difusas que por defecto propone INLA. Ajustamos el modelo y obtenemos las inferencias a posteriori</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">formula</span><span class="op">=</span><span class="va">coag</span> <span class="op">~</span> <span class="va">diet</span></span>
<span><span class="va">fit</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.html">inla</a></span><span class="op">(</span><span class="va">formula</span>,family<span class="op">=</span><span class="st">"gaussian"</span>,data<span class="op">=</span><span class="va">coagulation</span>,</span>
<span>         control.compute<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>return.marginals.predictor<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">fijos</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">summary.fixed</span>,<span class="fl">3</span><span class="op">)</span>;<span class="va">fijos</span></span>
<span><span class="co">#&gt;               mean    sd 0.025quant 0.5quant 0.975quant</span></span>
<span><span class="co">#&gt; (Intercept) 61.016 1.172     58.700   61.016     63.337</span></span>
<span><span class="co">#&gt; dietB        4.979 1.513      1.983    4.980      7.970</span></span>
<span><span class="co">#&gt; dietC        6.977 1.513      3.981    6.978      9.968</span></span>
<span><span class="co">#&gt; dietD       -0.016 1.435     -2.859   -0.016      2.822</span></span>
<span><span class="co">#&gt;             mode kld</span></span>
<span><span class="co">#&gt; (Intercept)   NA   0</span></span>
<span><span class="co">#&gt; dietB         NA   0</span></span>
<span><span class="co">#&gt; dietC         NA   0</span></span>
<span><span class="co">#&gt; dietD         NA   0</span></span>
<span><span class="va">tau</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">summary.hyperpar</span>,<span class="fl">3</span><span class="op">)</span>;<span class="va">tau</span></span>
<span><span class="co">#&gt;                                          mean    sd</span></span>
<span><span class="co">#&gt; Precision for the Gaussian observations 0.197 0.059</span></span>
<span><span class="co">#&gt;                                         0.025quant 0.5quant</span></span>
<span><span class="co">#&gt; Precision for the Gaussian observations      0.099    0.191</span></span>
<span><span class="co">#&gt;                                         0.975quant mode</span></span>
<span><span class="co">#&gt; Precision for the Gaussian observations      0.328   NA</span></span>
<span><span class="va">medias</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">summary.linear.predictor</span>,<span class="fl">4</span><span class="op">)</span></span></code></pre></div>
<p>Atendiendo a los descriptivos de la distribución posterior para los efectos fijos, concluimos:</p>
<ul>
<li>El tiempo esperado de coagulación para los animales que han seguido la dieta A es de 61.016(58.7,63.337).</li>
<li>Los animales que han seguido la dieta B tienen un tiempo de coagulación esperado superior en 4.979 unidades a los de la dieta A, y dicha diferencia es <em>significativamente distinta de cero</em> en el contexto bayesiano, dado que su HPD no incluye al cero, (1.983,7.97).</li>
<li>Una conclusión similar se deriva para la dieta C, que da un tiempo de coagulación esperado superior en 6.977 unidades a los de la dieta A, y un HPD (3.981,9.968).</li>
<li>Las diferencias en los tiempos de coagulación de seguir una dieta D frente a la dieta A no son relevantes. De hecho, la diferencia entre ellos es de -0.016 y el intervalo HPD contiene al cero, (-2.859,2.822).</li>
</ul>
<p>Pintamos a continuación en la Figura <a href="anova.html#fig:anova01">3.1</a> la distribución posterior de las medias <span class="math inline">\(\mu_i\)</span> (o predictores lineales) para cada una de las dietas.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dietas</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">coagulation</span><span class="op">$</span><span class="va">diet</span><span class="op">)</span></span>
<span><span class="va">pred</span><span class="op">=</span><span class="cn">NULL</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">dietas</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span><span class="va">index</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">coagulation</span><span class="op">$</span><span class="va">diet</span><span class="op">==</span><span class="va">dietas</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="co"># distrib. posterior</span></span>
<span><span class="va">post</span><span class="op">=</span><span class="va">fit</span><span class="op">$</span><span class="va">marginals.fitted.values</span><span class="op">[[</span><span class="va">index</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co"># media</span></span>
<span><span class="va">e</span><span class="op">=</span><span class="va">fit</span><span class="op">$</span><span class="va">summary.fitted.values</span><span class="op">[</span><span class="va">index</span>,<span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">hpd.low</span><span class="op">=</span><span class="va">fit</span><span class="op">$</span><span class="va">summary.fitted.values</span><span class="op">[</span><span class="va">index</span>,<span class="fl">3</span><span class="op">]</span></span>
<span><span class="va">hpd.up</span><span class="op">=</span><span class="va">fit</span><span class="op">$</span><span class="va">summary.fitted.values</span><span class="op">[</span><span class="va">index</span>,<span class="fl">5</span><span class="op">]</span></span>
<span><span class="va">pred</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">pred</span>,<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>dieta<span class="op">=</span><span class="va">dietas</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,</span>
<span>                           <span class="va">post</span>,e<span class="op">=</span><span class="va">e</span>,</span>
<span>                           hpd.low<span class="op">=</span><span class="va">hpd.low</span>,hpd.up<span class="op">=</span><span class="va">hpd.up</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">pred</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span><span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>color<span class="op">=</span><span class="va">dieta</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Tiempo medio de coagulación:"</span>,<span class="va">mu</span><span class="op">)</span><span class="op">)</span>,</span>
<span>       y<span class="op">=</span><span class="st">"D.Posterior"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:anova01"></span>
<img src="02-anova_files/figure-html/anova01-1.png" alt="Distribución posterior del tiempo medio de coagulación para las 4 dietas." width="672"><p class="caption">
Figura 3.1: Distribución posterior del tiempo medio de coagulación para las 4 dietas.
</p>
</div>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">pred</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span><span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>color<span class="op">=</span><span class="va">dieta</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>xintercept<span class="op">=</span><span class="va">e</span>,color<span class="op">=</span><span class="va">dieta</span><span class="op">)</span>,linetype<span class="op">=</span><span class="st">"dashed"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>xintercept<span class="op">=</span><span class="va">hpd.low</span>,color<span class="op">=</span><span class="va">dieta</span><span class="op">)</span>,linetype<span class="op">=</span><span class="st">"dotted"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>xintercept<span class="op">=</span><span class="va">hpd.up</span>,color<span class="op">=</span><span class="va">dieta</span><span class="op">)</span>,linetype<span class="op">=</span><span class="st">"dotted"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html">vars</a></span><span class="op">(</span><span class="va">dieta</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Tiempo medio de coagulación:"</span>,<span class="va">mu</span><span class="op">)</span><span class="op">)</span>,</span>
<span>       y<span class="op">=</span><span class="st">"D.Posterior"</span>,title<span class="op">=</span><span class="st">"D.Posterior, medias y HPD95%"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:anova02"></span>
<img src="02-anova_files/figure-html/anova02-1.png" alt="Distribuciones posteriores, medias y HPD" width="672"><p class="caption">
Figura 3.2: Distribuciones posteriores, medias y HPD
</p>
</div>
<p>Como ya hacíamos en regresión, podemos inferir sobre la desviación típica de los datos, <span class="math inline">\(\sigma\)</span>, transformando la distribución para la precisión <span class="math inline">\(\tau\)</span>.</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sigma.post</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/INLA/man/marginal.html">inla.tmarginal</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">tau</span><span class="op">)</span> <span class="va">tau</span><span class="op">^</span><span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>  <span class="va">fit</span><span class="op">$</span><span class="va">marginals.hyperpar</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co"># y la pintamos</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">sigma.post</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="va">sigma</span><span class="op">)</span>,y<span class="op">=</span><span class="st">"D.Posterior"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept<span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/INLA/man/marginal.html">inla.hpdmarginal</a></span><span class="op">(</span><span class="fl">0.95</span>,<span class="va">sigma.post</span><span class="op">)</span>,</span>
<span>             linetype<span class="op">=</span><span class="st">"dotted"</span>,color<span class="op">=</span><span class="st">"blue"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept<span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/INLA/man/marginal.html">inla.emarginal</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span>,<span class="va">sigma.post</span><span class="op">)</span>,</span>
<span>             linetype<span class="op">=</span><span class="st">"dashed"</span>,color<span class="op">=</span><span class="st">"blue"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="02-anova_files/figure-html/unnamed-chunk-4-1.png" width="672"></div>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Valor esperado</span></span>
<span><span class="va">sigma.e</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/INLA/man/marginal.html">inla.emarginal</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">tau</span><span class="op">)</span> <span class="va">tau</span><span class="op">^</span><span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>  <span class="va">fit</span><span class="op">$</span><span class="va">marginals.hyperpar</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>,<span class="fl">4</span><span class="op">)</span></span>
<span><span class="co"># HPD95%</span></span>
<span><span class="va">sigma.hpd</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/INLA/man/marginal.html">inla.hpdmarginal</a></span><span class="op">(</span><span class="fl">0.95</span>,<span class="va">sigma.post</span><span class="op">)</span>,<span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"E(sigma.post)="</span>,<span class="va">sigma.e</span>,<span class="st">"HPD95%=("</span>,<span class="va">sigma.hpd</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="st">","</span>,<span class="va">sigma.hpd</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,<span class="st">")"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "E(sigma.post)= 2.3347 HPD95%=( 1.681 , 3.069 )"</span></span></code></pre></div>
</div>
<div id="anova-de-varias-vías" class="section level2" number="3.4">
<h2>
<span class="header-section-number">3.4</span> Anova de varias vías<a class="anchor" aria-label="anchor" href="#anova-de-varias-v%C3%ADas"><i class="fas fa-link"></i></a>
</h2>
<p>Generalmente, y en especial cuando trabajamos con experimentación, son varios los factores que controlamos para investigar el efecto que producen en una respuesta continua. Hablamos de modelos de Anova de varias vías.</p>
<p>Utilizamos la base de datos <code>butterfat</code> en la librería <a href="https://cran.r-project.org/web/packages/faraway/faraway.pdf"><code>faraway</code></a> para ilustrar el ajuste con INLA de un modelo de Anova de varias vías. Esta base de datos contiene 100 registros del contenido en grasa láctea, <code>Butterfat</code>, para muestras aleatorias de 20 vacas (10 de ellas de 2 años y 10 maduras, con más de 4 años -en la variable <code>Age</code>) de cada una de cinco razas (en la variable <code>Breed</code>).</p>
<p>El objetivo es investigar las diferencias en materia grasa entre razas y edad, con el fin último de identificar cuáles producen más materia grasa y cuáles menos. Veamos los datos en la Figura <a href="anova.html#fig:butterfat1">3.3</a>.</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">butterfat</span>,package<span class="op">=</span><span class="st">"faraway"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">butterfat</span><span class="op">)</span></span>
<span><span class="co">#&gt; 'data.frame':    100 obs. of  3 variables:</span></span>
<span><span class="co">#&gt;  $ Butterfat: num  3.74 4.01 3.77 3.78 4.1 4.06 4.27 3.94 4.11 4.25 ...</span></span>
<span><span class="co">#&gt;  $ Breed    : Factor w/ 5 levels "Ayrshire","Canadian",..: 1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">#&gt;  $ Age      : Factor w/ 2 levels "2year","Mature": 2 1 2 1 2 1 2 1 2 1 ...</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">butterfat</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Breed</span>,y<span class="op">=</span><span class="va">Butterfat</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>color<span class="op">=</span><span class="va">Age</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">45</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:butterfat1"></span>
<img src="02-anova_files/figure-html/butterfat1-1.png" alt="Base de datos butterfat, en la librería Faraway" width="672"><p class="caption">
Figura 3.3: Base de datos butterfat, en la librería Faraway
</p>
</div>
<p>A la vista del gráfico, apreciamos que por lo general, en la mayoría de las razas, las vacas más jóvenes tienen menor contenido en materia grasa que las más viejas. Sin embargo, tal afirmación no parece tan clara en las razas <em>Guernsey</em> y <em>Holstein-Fresian</em>, de modo que para modelizar nuestros datos vamos a considerar a priori, la posibilidad de interacciones entre los factores de clasificación <code>Breed</code> y <code>Age</code>.</p>
<p>Cuando nos enfrentamos a varios factores de clasificación, cabe la posibilidad de que interaccionen entre ellos, esto es, que en algunos niveles de un factor actúen de forma diferente a los otros cuando se combinan con los niveles de algún otro factor. El orden de una interacción viene dado por el número de factores de clasificación que involucra, de modo que hablamos de interacciones de orden 2 si consideramos la interacción entre dos factores, de orden 3 si consideramos la interacción entre tres factores, etc. Generalmente trabajamos con interacciones de orden bajo, dada la complejidad de las conclusiones en interacciones de orden alto. Por otro lado, siempre es importante tener en cuenta de cuántos datos disponemos para conocer a priori la posibilidad de estimar con fiabilidad los distintos efectos de interacción (una interacción de dos factores con <span class="math inline">\(n_1\)</span> y <span class="math inline">\(n_2\)</span> niveles de clasificación respectivamente, revierte en la estimación de <span class="math inline">\((n_1-1)\times(n_2-1)\)</span> efectos de interacción).</p>
<p>Así, en nuestro problema si estamos planteando la posibilidad de que haya interacciones entre los dos factores de clasificación, estamos asumiendo un modelo de tipo siguiente, asumiendo normalidad en la respuesta:</p>
<p><span class="math display">\[(y_{ijk}|\eta_{ij},\sigma^2) \sim N(\eta_{ij},\sigma^2)\]</span>
con
<span class="math display">\[\eta_{ij}=\theta+ \alpha_i + \beta_j + \alpha\beta_{ij}\]</span>
donde <span class="math inline">\(\alpha_i\)</span> es el efecto diferencial (respecto del primer nivel) que aporta el nivel <span class="math inline">\(i\)</span> de la variable <code>Breed</code>, <span class="math inline">\(\beta_j\)</span> el efecto asociado a la variable <code>Age</code>, y <span class="math inline">\(\alpha\beta\)</span> la correspondiente interacción entre ellas. En <em>R</em> una interacción de orden 2 entre dos variables <span class="math inline">\(f_1\)</span> y <span class="math inline">\(f_2\)</span> se especifica con <span class="math inline">\(f_1:f_2\)</span>; los efectos principales y la interacción también se pueden especificar con <span class="math inline">\(f_1+f_2+f_1:f_2=f_1*f_2=(f_1+f_2)\)</span>^2.</p>
<p>Veamos cómo ajustar con INLA este modelo.</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">formula</span><span class="op">=</span><span class="va">Butterfat</span> <span class="op">~</span> <span class="va">Breed</span> <span class="op">*</span> <span class="va">Age</span></span>
<span><span class="va">fit</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.html">inla</a></span><span class="op">(</span><span class="va">formula</span>,data<span class="op">=</span><span class="va">butterfat</span>,</span>
<span>         control.compute<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>dic <span class="op">=</span> <span class="cn">TRUE</span>, waic <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">fit</span><span class="op">$</span><span class="va">summary.fixed</span></span>
<span><span class="co">#&gt;                                        mean        sd</span></span>
<span><span class="co">#&gt; (Intercept)                      3.96605050 0.1314176</span></span>
<span><span class="co">#&gt; BreedCanadian                    0.52193553 0.1858550</span></span>
<span><span class="co">#&gt; BreedGuernsey                    0.93293190 0.1858550</span></span>
<span><span class="co">#&gt; BreedHolstein-Fresian           -0.30304828 0.1858550</span></span>
<span><span class="co">#&gt; BreedJersey                      1.16693161 0.1858550</span></span>
<span><span class="co">#&gt; AgeMature                        0.18793906 0.1858476</span></span>
<span><span class="co">#&gt; BreedCanadian:AgeMature         -0.28692013 0.2628334</span></span>
<span><span class="co">#&gt; BreedGuernsey:AgeMature         -0.08591998 0.2628334</span></span>
<span><span class="co">#&gt; BreedHolstein-Fresian:AgeMature -0.17493825 0.2628334</span></span>
<span><span class="co">#&gt; BreedJersey:AgeMature            0.13107657 0.2628334</span></span>
<span><span class="co">#&gt;                                 0.025quant    0.5quant</span></span>
<span><span class="co">#&gt; (Intercept)                      3.7077564  3.96604997</span></span>
<span><span class="co">#&gt; BreedCanadian                    0.1566436  0.52193621</span></span>
<span><span class="co">#&gt; BreedGuernsey                    0.5676399  0.93293262</span></span>
<span><span class="co">#&gt; BreedHolstein-Fresian           -0.6683397 -0.30304778</span></span>
<span><span class="co">#&gt; BreedJersey                      0.8016396  1.16693233</span></span>
<span><span class="co">#&gt; AgeMature                       -0.1773381  0.18793970</span></span>
<span><span class="co">#&gt; BreedCanadian:AgeMature         -0.8035054 -0.28692097</span></span>
<span><span class="co">#&gt; BreedGuernsey:AgeMature         -0.6025053 -0.08592082</span></span>
<span><span class="co">#&gt; BreedHolstein-Fresian:AgeMature -0.6915241 -0.17493890</span></span>
<span><span class="co">#&gt; BreedJersey:AgeMature           -0.3855088  0.13107576</span></span>
<span><span class="co">#&gt;                                 0.975quant mode</span></span>
<span><span class="co">#&gt; (Intercept)                     4.22434758   NA</span></span>
<span><span class="co">#&gt; BreedCanadian                   0.88722356   NA</span></span>
<span><span class="co">#&gt; BreedGuernsey                   1.29821983   NA</span></span>
<span><span class="co">#&gt; BreedHolstein-Fresian           0.06224023   NA</span></span>
<span><span class="co">#&gt; BreedJersey                     1.53221952   NA</span></span>
<span><span class="co">#&gt; AgeMature                       0.55321257   NA</span></span>
<span><span class="co">#&gt; BreedCanadian:AgeMature         0.22966994   NA</span></span>
<span><span class="co">#&gt; BreedGuernsey:AgeMature         0.43067010   NA</span></span>
<span><span class="co">#&gt; BreedHolstein-Fresian:AgeMature 0.34165128   NA</span></span>
<span><span class="co">#&gt; BreedJersey:AgeMature           0.64766655   NA</span></span>
<span><span class="co">#&gt;                                          kld</span></span>
<span><span class="co">#&gt; (Intercept)                     2.741602e-09</span></span>
<span><span class="co">#&gt; BreedCanadian                   2.741873e-09</span></span>
<span><span class="co">#&gt; BreedGuernsey                   2.741872e-09</span></span>
<span><span class="co">#&gt; BreedHolstein-Fresian           2.741872e-09</span></span>
<span><span class="co">#&gt; BreedJersey                     2.741875e-09</span></span>
<span><span class="co">#&gt; AgeMature                       2.741035e-09</span></span>
<span><span class="co">#&gt; BreedCanadian:AgeMature         2.741453e-09</span></span>
<span><span class="co">#&gt; BreedGuernsey:AgeMature         2.741453e-09</span></span>
<span><span class="co">#&gt; BreedHolstein-Fresian:AgeMature 2.741453e-09</span></span>
<span><span class="co">#&gt; BreedJersey:AgeMature           2.741453e-09</span></span>
<span><span class="va">fit</span><span class="op">$</span><span class="va">dic</span><span class="op">$</span><span class="va">dic</span></span>
<span><span class="co">#&gt; [1] 120.4907</span></span>
<span><span class="va">fit</span><span class="op">$</span><span class="va">waic</span><span class="op">$</span><span class="va">waic</span></span>
<span><span class="co">#&gt; [1] 121.7376</span></span></code></pre></div>
<p>Observamos en la inferencia posterior para los efectos fijos, que todas las HPD asociadas a los efectos de interacción contienen al cero, lo que descarta la relevancia de la interacción a la hora de predecir la respuesta. Reajustamos pues el modelo eliminando la interacción, y comprobamos que efectivamente al eliminarla conseguimos reducir los valores del DIC y WAIC que usamos habitualmente para la selección de variables.</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">formula</span><span class="op">=</span><span class="va">Butterfat</span> <span class="op">~</span> <span class="va">Breed</span> <span class="op">+</span> <span class="va">Age</span></span>
<span><span class="va">fit</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.html">inla</a></span><span class="op">(</span><span class="va">formula</span>,data<span class="op">=</span><span class="va">butterfat</span>,</span>
<span>         control.predictor<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>compute<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>         control.compute<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>return.marginals.predictor<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>                              dic <span class="op">=</span> <span class="cn">TRUE</span>, waic <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">fit</span><span class="op">$</span><span class="va">summary.fixed</span></span>
<span><span class="co">#&gt;                             mean         sd  0.025quant</span></span>
<span><span class="co">#&gt; (Intercept)            4.0077184 0.10124849  3.80873722</span></span>
<span><span class="co">#&gt; BreedCanadian          0.3784787 0.13071123  0.12159390</span></span>
<span><span class="co">#&gt; BreedGuernsey          0.8899744 0.13071123  0.63308941</span></span>
<span><span class="co">#&gt; BreedHolstein-Fresian -0.3905147 0.13071123 -0.64739934</span></span>
<span><span class="co">#&gt; BreedJersey            1.2324714 0.13071123  0.97558640</span></span>
<span><span class="co">#&gt; AgeMature              0.1045993 0.08267001 -0.05787051</span></span>
<span><span class="co">#&gt;                         0.5quant 0.975quant mode</span></span>
<span><span class="co">#&gt; (Intercept)            4.0077182  4.2067006   NA</span></span>
<span><span class="co">#&gt; BreedCanadian          0.3784790  0.6353623   NA</span></span>
<span><span class="co">#&gt; BreedGuernsey          0.8899746  1.1468579   NA</span></span>
<span><span class="co">#&gt; BreedHolstein-Fresian -0.3905145 -0.1336309   NA</span></span>
<span><span class="co">#&gt; BreedJersey            1.2324717  1.4893548   NA</span></span>
<span><span class="co">#&gt; AgeMature              0.1045993  0.2670690   NA</span></span>
<span><span class="co">#&gt;                                kld</span></span>
<span><span class="co">#&gt; (Intercept)           2.524497e-09</span></span>
<span><span class="co">#&gt; BreedCanadian         2.524710e-09</span></span>
<span><span class="co">#&gt; BreedGuernsey         2.524709e-09</span></span>
<span><span class="co">#&gt; BreedHolstein-Fresian 2.524709e-09</span></span>
<span><span class="co">#&gt; BreedJersey           2.524709e-09</span></span>
<span><span class="co">#&gt; AgeMature             2.524942e-09</span></span>
<span><span class="va">fit</span><span class="op">$</span><span class="va">waic</span><span class="op">$</span><span class="va">waic</span></span>
<span><span class="co">#&gt; [1] 116.3439</span></span>
<span><span class="va">fit</span><span class="op">$</span><span class="va">dic</span><span class="op">$</span><span class="va">dic</span></span>
<span><span class="co">#&gt; [1] 115.381</span></span></code></pre></div>
<p>Observamos ya a partir del modelo ajustado, que el efecto de la edad no es relevante (su HPD incluye al cero), pero sin embargo sí que hay diferencias debido a las razas.</p>
<p>Reajustamos de nuevo el modelo, excluyendo la variable <code>Age</code>, y verificamos la reducción (ligera) del DIC/WAIC, lo cual justifica usar este modelo para la predicción.</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">formula</span><span class="op">=</span><span class="va">Butterfat</span> <span class="op">~</span> <span class="va">Breed</span> </span>
<span><span class="va">fit</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.html">inla</a></span><span class="op">(</span><span class="va">formula</span>,data<span class="op">=</span><span class="va">butterfat</span>,</span>
<span>         control.predictor<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>compute<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>         control.compute<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>return.marginals.predictor<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>                              dic <span class="op">=</span> <span class="cn">TRUE</span>, waic <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">fit</span><span class="op">$</span><span class="va">summary.fixed</span></span>
<span><span class="co">#&gt;                             mean         sd 0.025quant</span></span>
<span><span class="co">#&gt; (Intercept)            4.0600181 0.09271797  3.8778058</span></span>
<span><span class="co">#&gt; BreedCanadian          0.3784786 0.13112330  0.1207895</span></span>
<span><span class="co">#&gt; BreedGuernsey          0.8899742 0.13112330  0.6322850</span></span>
<span><span class="co">#&gt; BreedHolstein-Fresian -0.3905148 0.13112330 -0.6482037</span></span>
<span><span class="co">#&gt; BreedJersey            1.2324713 0.13112330  0.9747819</span></span>
<span><span class="co">#&gt;                         0.5quant 0.975quant mode</span></span>
<span><span class="co">#&gt; (Intercept)            4.0600180  4.2422316   NA</span></span>
<span><span class="co">#&gt; BreedCanadian          0.3784788  0.6361665   NA</span></span>
<span><span class="co">#&gt; BreedGuernsey          0.8899745  1.1476620   NA</span></span>
<span><span class="co">#&gt; BreedHolstein-Fresian -0.3905146 -0.1328267   NA</span></span>
<span><span class="co">#&gt; BreedJersey            1.2324715  1.4901590   NA</span></span>
<span><span class="co">#&gt;                                kld</span></span>
<span><span class="co">#&gt; (Intercept)           2.473329e-09</span></span>
<span><span class="co">#&gt; BreedCanadian         2.473494e-09</span></span>
<span><span class="co">#&gt; BreedGuernsey         2.473491e-09</span></span>
<span><span class="co">#&gt; BreedHolstein-Fresian 2.473494e-09</span></span>
<span><span class="co">#&gt; BreedJersey           2.473492e-09</span></span>
<span><span class="va">fit</span><span class="op">$</span><span class="va">waic</span><span class="op">$</span><span class="va">waic</span></span>
<span><span class="co">#&gt; [1] 115.9279</span></span>
<span><span class="va">fit</span><span class="op">$</span><span class="va">dic</span><span class="op">$</span><span class="va">dic</span></span>
<span><span class="co">#&gt; [1] 115.0075</span></span></code></pre></div>
<p>Procederíamos igual que en el modelo de Anova de una vía para la representación de las distribuciones posteriores sobre las medias o predictores lineales en cada una de las razas. Igualmente representaremos la distribución posterior del parámetro de dispersión de los datos <span class="math inline">\(\sigma\)</span>.</p>
</div>
<div id="análisis-de-ancova" class="section level2" number="3.5">
<h2>
<span class="header-section-number">3.5</span> Análisis de ANCOVA<a class="anchor" aria-label="anchor" href="#an%C3%A1lisis-de-ancova"><i class="fas fa-link"></i></a>
</h2>
<p>En ocasiones tenemos una variable respuesta de tipo numérico, y como posibles predictores variables de tipo numérico y también variables clasificadoras o factores. Surge entonces la posibilidad de que los predictores numéricos afecten a la respuesta de modo distinto en diferentes niveles de clasificación de los factores; hablamos entonces de interacción entre covariables y factores. Veamos un ejemplo para comprender cómo funcionan estos modelos y cómo se ajustan con INLA.</p>
<p>Consideramos los datos de Galton sobre la regresión de las alturas de los hijos sobre la de los padres (Fte: <a href="http://www.randomservices.org/random/">Galton’s Height Data</a>). Tenemos la estatura del padre, de la madre y del hijo/a, identificado/a por su sexo.
Vamos a formular un modelo de regresión de la estatura de los hijos en función de la de sus padres y su género.</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my.dir</span><span class="op">=</span><span class="st">"~/Dropbox/ESTADISTICA/BAYESIAN/VARIOS/"</span></span>
<span><span class="va">datos</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span>file<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">my.dir</span>,<span class="st">"Galton.txt"</span><span class="op">)</span>,header<span class="op">=</span><span class="cn">TRUE</span>,dec<span class="op">=</span><span class="st">"."</span>, sep<span class="op">=</span><span class="st">""</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">datos</span><span class="op">)</span></span>
<span><span class="co">#&gt; 'data.frame':    898 obs. of  6 variables:</span></span>
<span><span class="co">#&gt;  $ Family: chr  "1" "1" "1" "1" ...</span></span>
<span><span class="co">#&gt;  $ Father: num  78.5 78.5 78.5 78.5 75.5 75.5 75.5 75.5 75 75 ...</span></span>
<span><span class="co">#&gt;  $ Mother: num  67 67 67 67 66.5 66.5 66.5 66.5 64 64 ...</span></span>
<span><span class="co">#&gt;  $ Gender: chr  "M" "F" "F" "F" ...</span></span>
<span><span class="co">#&gt;  $ Height: num  73.2 69.2 69 69 73.5 72.5 65.5 65.5 71 68 ...</span></span>
<span><span class="co">#&gt;  $ Kids  : int  4 4 4 4 4 4 4 4 2 2 ...</span></span></code></pre></div>
<p>Asumimos pues como respuesta la variable <code>y=Height</code>, como regresores las variables <span class="math inline">\(x_1=\)</span><code>Father</code> y <span class="math inline">\(x_2=\)</span><code>Mother</code> con las estaturas del padre y la madre respectivamente, y con factor de clasificación la variable <span class="math inline">\(G=\)</span><code>Gender</code>, con niveles M/F. En principio cabrían posibles interacciones entre los regresores y los factores de clasificación, por lo que planteamos el modelo:</p>
<p><span class="math display">\[(y_{ij}|\eta_{ij},\sigma^2) \sim N(\eta_{ij},\sigma^2)\]</span>
con el predictor lineal
<span class="math display">\[\eta_{ij}=\mu_{ij}=\beta_0+(\beta_1 + \alpha_{1M}) x_{1j} + (\beta_2+ \alpha_{2M}) x_{2j} + \alpha_M;\ \  j =1,...,n_i; i=M,F\]</span>
donde <span class="math inline">\(\alpha_M\)</span> es el efecto diferencial global de los hombres frente a las mujeres al predecir la estatura, y <span class="math inline">\(\alpha_{1M},\alpha_{2M}\)</span> los efectos diferenciales que afectan a los regresores.</p>
<p>Asumimos una distribución vaga sobre <span class="math inline">\(\beta_0, \beta_1\)</span> y <span class="math inline">\(\tau=1/\sigma^2\)</span> y ajustamos el modelo Gausiano en INLA:</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">formula</span> <span class="op">=</span> <span class="va">Height</span> <span class="op">~</span> <span class="fl">1</span><span class="op">+</span><span class="op">(</span><span class="va">Father</span><span class="op">+</span><span class="va">Mother</span><span class="op">)</span><span class="op">*</span><span class="va">Gender</span></span>
<span><span class="va">fit</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.html">inla</a></span><span class="op">(</span><span class="va">formula</span>,family <span class="op">=</span> <span class="st">"gaussian"</span>,data<span class="op">=</span><span class="va">datos</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">summary.fixed</span>,<span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt;                  mean    sd 0.025quant 0.5quant 0.975quant</span></span>
<span><span class="co">#&gt; (Intercept)    16.652 3.887      9.028   16.652     24.276</span></span>
<span><span class="co">#&gt; Father          0.400 0.039      0.324    0.400      0.477</span></span>
<span><span class="co">#&gt; Mother          0.307 0.045      0.218    0.307      0.396</span></span>
<span><span class="co">#&gt; GenderM         2.707 5.427     -7.939    2.707     13.353</span></span>
<span><span class="co">#&gt; Father:GenderM  0.012 0.058     -0.103    0.012      0.126</span></span>
<span><span class="co">#&gt; Mother:GenderM  0.027 0.062     -0.096    0.027      0.149</span></span>
<span><span class="co">#&gt;                mode kld</span></span>
<span><span class="co">#&gt; (Intercept)      NA   0</span></span>
<span><span class="co">#&gt; Father           NA   0</span></span>
<span><span class="co">#&gt; Mother           NA   0</span></span>
<span><span class="co">#&gt; GenderM          NA   0</span></span>
<span><span class="co">#&gt; Father:GenderM   NA   0</span></span>
<span><span class="co">#&gt; Mother:GenderM   NA   0</span></span></code></pre></div>
<p>Observamos que ninguna de las interacciones tienen un efecto a considerar (su HPD posterior incluye al cero), de modo que las descartamos y reajustamos el modelo sin ellas.</p>
<p><span class="math display">\[\eta_{ij}=\mu_{ij}=\beta_0+ \beta_1  x_{1j} + \beta_2 x_{2j} + \alpha_M;\ \  j =1,...,n_i; i=M,F.\]</span></p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">formula</span> <span class="op">=</span> <span class="va">Height</span> <span class="op">~</span> <span class="va">Father</span><span class="op">+</span><span class="va">Mother</span><span class="op">+</span><span class="va">Gender</span></span>
<span><span class="va">fit</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.html">inla</a></span><span class="op">(</span><span class="va">formula</span>,family <span class="op">=</span> <span class="st">"gaussian"</span>,data<span class="op">=</span><span class="va">datos</span>,</span>
<span>        control.predictor<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>compute<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>         control.compute<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>return.marginals.predictor<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>                              dic <span class="op">=</span> <span class="cn">TRUE</span>, waic <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">summary.fixed</span>,<span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt;               mean    sd 0.025quant 0.5quant 0.975quant</span></span>
<span><span class="co">#&gt; (Intercept) 15.345 2.747      9.958   15.345     20.733</span></span>
<span><span class="co">#&gt; Father       0.406 0.029      0.349    0.406      0.463</span></span>
<span><span class="co">#&gt; Mother       0.321 0.031      0.260    0.321      0.383</span></span>
<span><span class="co">#&gt; GenderM      5.226 0.144      4.943    5.226      5.508</span></span>
<span><span class="co">#&gt;             mode kld</span></span>
<span><span class="co">#&gt; (Intercept)   NA   0</span></span>
<span><span class="co">#&gt; Father        NA   0</span></span>
<span><span class="co">#&gt; Mother        NA   0</span></span>
<span><span class="co">#&gt; GenderM       NA   0</span></span></code></pre></div>
<p>Ahora todos los efectos fijos son relevantes para predecir la estatura de los hijos. Utilizamos este modelo para derivar las inferencias.</p>
<p>Representamos a continuación en la Figura (fig:galton1) las distribuciones posteriores de los efectos fijos:</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fixed</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">marginals.fixed</span><span class="op">)</span></span>
<span><span class="va">g</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">fixed</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">g</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">marginals.fixed</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x</span>,y<span class="op">=</span><span class="va">y</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept<span class="op">=</span><span class="va">fit</span><span class="op">$</span><span class="va">summary.fixed</span><span class="op">$</span><span class="va">mean</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,linetype<span class="op">=</span><span class="st">"dashed"</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept<span class="op">=</span><span class="va">fit</span><span class="op">$</span><span class="va">summary.fixed</span><span class="op">[</span><span class="va">i</span>,<span class="fl">3</span><span class="op">]</span>,linetype<span class="op">=</span><span class="st">"dotted"</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept<span class="op">=</span><span class="va">fit</span><span class="op">$</span><span class="va">summary.fixed</span><span class="op">[</span><span class="va">i</span>,<span class="fl">5</span><span class="op">]</span>,linetype<span class="op">=</span><span class="st">"dotted"</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">fixed</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,y<span class="op">=</span><span class="st">"D.posterior"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html">grid.arrange</a></span><span class="op">(</span><span class="va">g</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,<span class="va">g</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>,<span class="va">g</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span>,<span class="va">g</span><span class="op">[[</span><span class="fl">4</span><span class="op">]</span><span class="op">]</span>,ncol<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:galton1"></span>
<img src="02-anova_files/figure-html/galton1-1.png" alt="Distribución posterior de los efectos fijos" width="672"><p class="caption">
Figura 3.4: Distribución posterior de los efectos fijos
</p>
</div>
<p>En media observamos que la estatura de los hombres es 5.23 unidades superior a la de las mujeres.</p>
<p>Con estas distribuciones podemos calcular cualquier probabilidad, como por ejemplo,la probabilidad de que la estatura de un hombre, sean como sean sus ancestros, supere en 5 unidades a la de una mujer:</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fl">1</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/pkg/INLA/man/marginal.html">inla.pmarginal</a></span><span class="op">(</span><span class="fl">5</span>,<span class="va">fit</span><span class="op">$</span><span class="va">marginals.fixed</span><span class="op">$</span><span class="st">"GenderM"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.94144</span></span></code></pre></div>
<p>Podemos acceder a las distribuciones posteriores de la estatura esperada de un sujeto y posicionar las estaturas de sus padres, que se muestran en la Figura <a href="anova.html#fig:galton2">3.5</a></p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># la predicción del predictor lineal para cada sujeto es:</span></span>
<span><span class="va">pred</span><span class="op">&lt;-</span><span class="va">fit</span><span class="op">$</span><span class="va">marginals.linear.predictor</span></span>
<span><span class="co"># que en este caso coincide con los valores ajustados</span></span>
<span><span class="va">fitted</span><span class="op">&lt;-</span><span class="va">fit</span><span class="op">$</span><span class="va">marginals.fitted.values</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">pred</span><span class="op">$</span><span class="va">Predictor.1</span><span class="op">)</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x</span>,y<span class="op">=</span><span class="va">y</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x<span class="op">=</span><span class="st">"Estatura media del sujeto 1"</span>,y<span class="op">=</span><span class="st">"D.posterior"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept<span class="op">=</span><span class="va">fit</span><span class="op">$</span><span class="va">summary.fitted.values</span><span class="op">$</span><span class="va">mean</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,linetype<span class="op">=</span><span class="st">"dashed"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept<span class="op">=</span><span class="va">datos</span><span class="op">$</span><span class="va">Father</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,linetype<span class="op">=</span><span class="st">"dashed"</span>,color<span class="op">=</span><span class="st">"blue"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept<span class="op">=</span><span class="va">datos</span><span class="op">$</span><span class="va">Mother</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,linetype<span class="op">=</span><span class="st">"dashed"</span>,color<span class="op">=</span><span class="st">"pink"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span><span class="st">"text"</span>,x<span class="op">=</span><span class="va">datos</span><span class="op">$</span><span class="va">Mother</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">+</span><span class="fl">1</span>,y<span class="op">=</span><span class="fl">1</span>,label<span class="op">=</span><span class="st">"Madre"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span><span class="st">"text"</span>,x<span class="op">=</span><span class="va">datos</span><span class="op">$</span><span class="va">Father</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">-</span><span class="fl">1</span>,y<span class="op">=</span><span class="fl">1</span>,label<span class="op">=</span><span class="st">"Padre"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:galton2"></span>
<img src="02-anova_files/figure-html/galton2-1.png" alt="Predicción de la estatura del primer sujeto en la muestra" width="672"><p class="caption">
Figura 3.5: Predicción de la estatura del primer sujeto en la muestra
</p>
</div>
<p>Podemos ir más allá, prediciendo la estatura de un sujeto, sea hombre o mujer, cuando su padre mide 1.75m (68.9 pulgadas) y su madre 1.70m (66.9 pulgadas). Expresamos los resultados en centímetros.</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">new.data</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>Father<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">68.9</span>,<span class="fl">68.9</span><span class="op">)</span>,</span>
<span>                    Mother<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">66.9</span>,<span class="fl">66.9</span><span class="op">)</span>,</span>
<span>                    Gender<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"M"</span>,<span class="st">"F"</span><span class="op">)</span>,</span>
<span>                    Height<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">NA</span>,<span class="cn">NA</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">datos.combinado</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">datos</span>, <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>Family<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">NA</span>,<span class="cn">NA</span><span class="op">)</span>,<span class="va">new.data</span>,Kids<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">NA</span>,<span class="cn">NA</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## creamos un vector con NA's para observaciones y 1's para predicciones</span></span>
<span><span class="va">datos.indicador</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">datos</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">new.data</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## reajustamos el modelo añadiendo la opción de predicción de datos</span></span>
<span><span class="va">fit.pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.html">inla</a></span><span class="op">(</span><span class="va">formula</span>, data <span class="op">=</span> <span class="va">datos.combinado</span>, </span>
<span>                 control.compute<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>return.marginals.predictor<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>                 control.predictor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>link <span class="op">=</span> <span class="va">datos.indicador</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## y describimos los valores ajustados para los escenarios añadidos</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">fit.pred</span><span class="op">$</span><span class="va">summary.fitted.values</span><span class="op">[</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">datos</span><span class="op">)</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">datos.combinado</span><span class="op">)</span>,<span class="op">]</span><span class="op">*</span><span class="fl">2.54</span>,<span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt;                       mean  sd 0.025quant 0.5quant</span></span>
<span><span class="co">#&gt; fitted.Predictor.899 177.9 0.3      177.3    177.9</span></span>
<span><span class="co">#&gt; fitted.Predictor.900 164.7 0.3      164.0    164.7</span></span>
<span><span class="co">#&gt;                      0.975quant mode</span></span>
<span><span class="co">#&gt; fitted.Predictor.899      178.6   NA</span></span>
<span><span class="co">#&gt; fitted.Predictor.900      165.3   NA</span></span></code></pre></div>
<p>También graficar las distribuciones predictivas y probabilidades (Figura <a href="anova.html#fig:galton3">3.6</a>:</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Distribuciones predictivas</span></span>
<span><span class="va">pred.M</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">fit.pred</span><span class="op">$</span><span class="va">marginals.fitted.values</span><span class="op">[[</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">datos</span><span class="op">)</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">*</span><span class="fl">2.54</span></span>
<span><span class="va">pred.F</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">fit.pred</span><span class="op">$</span><span class="va">marginals.fitted.values</span><span class="op">[[</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">datos</span><span class="op">)</span><span class="op">+</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">*</span><span class="fl">2.54</span></span>
<span><span class="va">d.pred</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">pred.M</span>,<span class="va">pred.F</span><span class="op">)</span></span>
<span><span class="co"># atributo Gender</span></span>
<span><span class="va">d.pred</span><span class="op">$</span><span class="va">Gender</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"M"</span>,<span class="st">"F"</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">pred.M</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">pred.F</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># objetivo de estatura</span></span>
<span><span class="va">d.pred</span><span class="op">$</span><span class="va">obj</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">178</span>,<span class="fl">165</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">pred.M</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">pred.F</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">d.pred</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x</span>,y<span class="op">=</span><span class="va">y</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>xintercept<span class="op">=</span><span class="va">obj</span><span class="op">)</span>,linetype<span class="op">=</span><span class="st">"dashed"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html">vars</a></span><span class="op">(</span><span class="va">Gender</span><span class="op">)</span>,scales<span class="op">=</span><span class="st">"free"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x<span class="op">=</span><span class="st">"Estatura"</span>,y<span class="op">=</span><span class="st">"D.posterior"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:galton3"></span>
<img src="02-anova_files/figure-html/galton3-1.png" alt="Distribución predictiva de la estatura de un sujeto cuyo padre mide 1,75cm y madre 1,07cm." width="672"><p class="caption">
Figura 3.6: Distribución predictiva de la estatura de un sujeto cuyo padre mide 1,75cm y madre 1,07cm.
</p>
</div>
<p>Y calcular probabilidades, como la probabilidad de que dicho sujeto supere el 1.65m si es mujer, o el 1.78m si es hombre.</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># cálculo de probabilidades</span></span>
<span><span class="va">p165F</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/pkg/INLA/man/marginal.html">inla.pmarginal</a></span><span class="op">(</span><span class="fl">165</span>,<span class="va">pred.F</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Pr(estatura&gt;165|mujer,padre=175,madre=170)="</span>,<span class="va">p165F</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Pr(estatura&gt;165|mujer,padre=175,madre=170)= 0.16</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="va">p178M</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/pkg/INLA/man/marginal.html">inla.pmarginal</a></span><span class="op">(</span><span class="fl">178</span>,<span class="va">pred.M</span><span class="op">)</span>,<span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Pr(estatura&gt;178|hombre,padre=175,madre=170)="</span>,<span class="va">p178M</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Pr(estatura&gt;178|hombre,padre=175,madre=170)= 0.42</span></span></code></pre></div>
<p>Podríamos también, modificar las especificaciones a priori sobre los parámetros <span class="math inline">\(\beta_0\)</span> y <span class="math inline">\(\beta_1\)</span> mediante el comando <code>control.fixed</code>. Por ejemplo, queremos asumir a priori <span class="math inline">\(\beta_0\sim N(0,10^4)\)</span> y <span class="math inline">\(\beta_1\sim N(0,100)\)</span> y ver cómo afecta a las inferencias.</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.html">inla</a></span><span class="op">(</span><span class="va">formula</span>,family<span class="op">=</span><span class="st">"gaussian"</span>,data<span class="op">=</span><span class="va">datos</span>,</span>
<span>                   control.fixed<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>mean<span class="op">=</span><span class="fl">0</span>,prec<span class="op">=</span><span class="fl">0.01</span>,</span>
<span>                   mean.intercept<span class="op">=</span><span class="fl">0</span>, prec.intercept<span class="op">=</span><span class="fl">0.0001</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">summary.fixed</span>,<span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt;               mean    sd 0.025quant 0.5quant 0.975quant</span></span>
<span><span class="co">#&gt; (Intercept) 15.335 2.746      9.949   15.335     20.721</span></span>
<span><span class="co">#&gt; Father       0.406 0.029      0.349    0.406      0.463</span></span>
<span><span class="co">#&gt; Mother       0.322 0.031      0.260    0.322      0.383</span></span>
<span><span class="co">#&gt; GenderM      5.225 0.144      4.942    5.225      5.507</span></span>
<span><span class="co">#&gt;             mode kld</span></span>
<span><span class="co">#&gt; (Intercept)   NA   0</span></span>
<span><span class="co">#&gt; Father        NA   0</span></span>
<span><span class="co">#&gt; Mother        NA   0</span></span>
<span><span class="co">#&gt; GenderM       NA   0</span></span></code></pre></div>
<p>Si queremos especificar medias a priori diferentes para los coeficientes de los distintos regresores, hemos de especificarlos con listas.</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.html">inla</a></span><span class="op">(</span><span class="va">formula</span>,family <span class="op">=</span> <span class="st">"gaussian"</span>,data<span class="op">=</span><span class="va">datos</span>,</span>
<span>                   control.fixed<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>mean<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>Father<span class="op">=</span><span class="fl">0.2</span>,Mother<span class="op">=</span><span class="fl">0.1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">summary.fixed</span>,<span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt;               mean    sd 0.025quant 0.5quant 0.975quant</span></span>
<span><span class="co">#&gt; (Intercept) 15.345 2.747      9.957   15.345     20.733</span></span>
<span><span class="co">#&gt; Father       0.406 0.029      0.349    0.406      0.463</span></span>
<span><span class="co">#&gt; Mother       0.321 0.031      0.260    0.321      0.383</span></span>
<span><span class="co">#&gt; GenderM      5.226 0.144      4.943    5.226      5.508</span></span>
<span><span class="co">#&gt;             mode kld</span></span>
<span><span class="co">#&gt; (Intercept)   NA   0</span></span>
<span><span class="co">#&gt; Father        NA   0</span></span>
<span><span class="co">#&gt; Mother        NA   0</span></span>
<span><span class="co">#&gt; GenderM       NA   0</span></span></code></pre></div>
<p>Si queremos modificar la especificación de la prior en <span class="math inline">\(\sigma^2\)</span>, o lo que es equivalente, en la precisión <span class="math inline">\(\tau\)</span>, con la distribución <span class="math inline">\(log(\tau) \sim N(0,1)\)</span> en lugar de <span class="math inline">\(\tau \sim Ga(1,10^{-5})\)</span>, vemos cómo afecta a la inferencia posterior sobre la precisión.</p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_n</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.html">inla</a></span><span class="op">(</span><span class="va">formula</span>,family<span class="op">=</span><span class="st">"gaussian"</span>, data<span class="op">=</span><span class="va">datos</span>,</span>
<span>                   control.family<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>hyper<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>                     prec<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>prior<span class="op">=</span><span class="st">"gaussian"</span>,param<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># con el modelo log-gamma para precisión</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">summary.hyperpar</span>,<span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt;                                          mean   sd</span></span>
<span><span class="co">#&gt; Precision for the Gaussian observations 0.216 0.01</span></span>
<span><span class="co">#&gt;                                         0.025quant 0.5quant</span></span>
<span><span class="co">#&gt; Precision for the Gaussian observations      0.197    0.216</span></span>
<span><span class="co">#&gt;                                         0.975quant mode</span></span>
<span><span class="co">#&gt; Precision for the Gaussian observations      0.236   NA</span></span>
<span><span class="co"># con el modelo normal para precisión</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">fit_n</span><span class="op">$</span><span class="va">summary.hyperpar</span>,<span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt;                                          mean   sd</span></span>
<span><span class="co">#&gt; Precision for the Gaussian observations 0.216 0.01</span></span>
<span><span class="co">#&gt;                                         0.025quant 0.5quant</span></span>
<span><span class="co">#&gt; Precision for the Gaussian observations      0.197    0.216</span></span>
<span><span class="co">#&gt;                                         0.975quant mode</span></span>
<span><span class="co">#&gt; Precision for the Gaussian observations      0.236   NA</span></span></code></pre></div>
<p>Cuando tenemos información previa disponible sobre la variación de los datos, será generalmente más intuitivo expresarla en términos de la desviación estándar <span class="math inline">\(\sigma\)</span>. Bastará con conseguir la equivalencia en la escala de <span class="math inline">\(log(\tau)\)</span> para incluirla en el modelo. Por ejemplo, si sabemos que la desviación típica está entre 2 y 14, <span class="math inline">\(\sigma \sim Unif(2,14)\)</span>, podemos calcular una prior para la log-precisión del siguiente modo:</p>
<ol style="list-style-type: decimal">
<li>simular una muestra de <span class="math inline">\(\sigma \sim Unif(2,14)\)</span>
</li>
<li>transformar a precisiones</li>
<li>calcular los parámetros de la Gamma para la precisión, a partir de su media y varianza</li>
</ol>
<p>Hacemos los cálculos y graficamos la prior en la Figura <a href="anova.html#fig:galton4">3.7</a>.</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># parámetros para sigma~Un(a1,b1)</span></span>
<span><span class="va">a1</span><span class="op">&lt;-</span><span class="fl">2</span></span>
<span><span class="va">b1</span><span class="op">&lt;-</span><span class="fl">14</span></span>
<span><span class="co"># simulamos sigma de una distribución Unif(a1,b1)</span></span>
<span><span class="va">sigma</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">10000</span>,min<span class="op">=</span><span class="va">a1</span>,max<span class="op">=</span><span class="va">b1</span><span class="op">)</span></span>
<span><span class="co"># obtenemos la precisión</span></span>
<span><span class="va">tau</span><span class="op">&lt;-</span><span class="fl">1</span><span class="op">/</span><span class="va">sigma</span><span class="op">^</span><span class="fl">2</span></span>
<span><span class="co"># Calculamos los parámetros alpha,beta de una distrib. Gamma para la precisión</span></span>
<span><span class="co"># mean=alpha/beta; var=alpha/beta^2</span></span>
<span><span class="va">beta</span><span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">tau</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html">var</a></span><span class="op">(</span><span class="va">tau</span><span class="op">)</span></span>
<span><span class="va">alpha</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">tau</span><span class="op">)</span><span class="op">*</span><span class="va">beta</span></span>
<span><span class="co"># dibujamos los valores de la precisión</span></span>
<span><span class="va">tau.seq</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="va">tau</span><span class="op">)</span></span>
<span>  <span class="co"># seq(min(tau),max(tau),length=1000)</span></span>
<span><span class="va">prior</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>tau<span class="op">=</span><span class="va">tau.seq</span>,dprior<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html">dgamma</a></span><span class="op">(</span><span class="va">tau.seq</span>,<span class="va">alpha</span>,<span class="va">beta</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">prior</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">tau</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">..density..</span><span class="op">)</span>,color<span class="op">=</span><span class="st">"grey"</span>,fill<span class="op">=</span><span class="st">"white"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">dprior</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; `stat_bin()` using `bins = 30`. Pick better value with</span></span>
<span><span class="co">#&gt; `binwidth`.</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:galton4"></span>
<img src="02-anova_files/figure-html/galton4-1.png" alt="Distribución a prior para tau con sigma ~ Uniforme(2,14)" width="672"><p class="caption">
Figura 3.7: Distribución a prior para tau con sigma ~ Uniforme(2,14)
</p>
</div>
<p>Utilicemos pues esos parámetros para especificar la prior sobre <span class="math inline">\(\tau\)</span> en INLA:</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.html">inla</a></span><span class="op">(</span><span class="va">formula</span>,family<span class="op">=</span><span class="st">"gaussian"</span>,data<span class="op">=</span><span class="va">datos</span>,</span>
<span>                   control.family<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>hyper<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>                     prec<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>prior<span class="op">=</span><span class="st">"loggamma"</span>,param<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">alpha</span>,<span class="va">beta</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">summary.hyperpar</span>,<span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt;                                          mean   sd</span></span>
<span><span class="co">#&gt; Precision for the Gaussian observations 0.214 0.01</span></span>
<span><span class="co">#&gt;                                         0.025quant 0.5quant</span></span>
<span><span class="co">#&gt; Precision for the Gaussian observations      0.195    0.214</span></span>
<span><span class="co">#&gt;                                         0.975quant mode</span></span>
<span><span class="co">#&gt; Precision for the Gaussian observations      0.234   NA</span></span></code></pre></div>
</div>
<div id="efectos-aleatorios" class="section level2" number="3.6">
<h2>
<span class="header-section-number">3.6</span> Efectos aleatorios<a class="anchor" aria-label="anchor" href="#efectos-aleatorios"><i class="fas fa-link"></i></a>
</h2>
<p>Desde una perspectiva frecuentista un modelo básico de Anova podría ser un modelo de efectos fijos, pero también de efectos aleatorios. Así por ejemplo el tratamiento dado en un ensayo clínico importa para comparar y diferenciar el efecto que provoca sobre un paciente; tratamiento en entonces es un efecto fijo, de interés primario. En otro ejemplo, se han aplicado varios fertilizantes a cultivos en fincas distintas; el interés primario será comparar los fertilizantes, pero no las fincas, por lo que fertilizante será un efecto fijo; sin embargo, el factor finca sólo tiene interés por cuanto aporta variabilidad en la respuesta, y no para comparar las fincas, por lo que se considerará como un efecto aleatorio.</p>
<p>Una variable predictiva, numérica o categórica, entra en el modelo como <strong>efecto fijo</strong> cuando se piensa que afecta a todas las observaciones del mismo modo (de un modo lineal), y que su efecto es de interés primario en el estudio.
En un contexto bayesiano un efecto fijo tendrá un coeficiente asociado al que se le asigna a menudo una distribución a priori vaga (mínimo informativa), como una gausiana con media cero y varianza (conocida) grande. En cualquier caso, la distribución a priori que se asume para los efectos fijos es siempre una distribución conocida.</p>
<p>Un <strong>efecto aleatorio</strong> identifica a variables de tipo categórico que no son de interés primario en la investigación, pero que se considera que añaden incertidumbre y por lo tanto variabilidad a la respuesta. La modelización habitual de los efectos aleatorios es una prior gausiana con media cero y una precisión desconocida, para la que será preciso asignar una distribución a priori. La distribución a priori de los efectos aleatorios tiene parámetros desconocidos, llamados <strong>hiperparámetros</strong>, a los que hay que asignar asimismo una distribución a priori.</p>
<p>Puesto que no salimos del modelo lineal, seguiremos asumiendo una respuesta normal, <em>gaussian</em>, con media igual a un predictor lineal <span class="math inline">\(\eta=\theta+ Z u\)</span>, donde <span class="math inline">\(Z\)</span> es la correspondiente matriz de diseño para los efectos aleatorios <span class="math inline">\(z_1, z_2,...\)</span>. Se asume además una varianza desconocida <span class="math inline">\(\sigma^2\)</span>.</p>
<p>En INLA la fórmula de predicción de una respuesta <span class="math inline">\(y\)</span> a partir de un conjunto de efectos aleatorios z1,z2,… se especifica como:</p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">formula</span> <span class="op">=</span> <span class="va">y</span> <span class="op">~</span> <span class="fl">1</span>  <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html">f</a></span><span class="op">(</span><span class="va">z1</span>, model<span class="op">=</span><span class="st">""</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html">f</a></span><span class="op">(</span><span class="va">z2</span>,model<span class="op">=</span><span class="st">""</span><span class="op">)</span> </span></code></pre></div>
<p>donde la función <span class="math inline">\(f()\)</span> especifica la relación entre el predictor lineal de la respuesta y los efectos aleatorios <span class="math inline">\(z\)</span>. El tipo de relación asumida se incluye en el argumento <code>model</code> o modelo latente, que tiene como posibilidades <code>names(inla.models()$latent)</code>, si bien en el modelo lineal la opción habitual es <code>model="iid"</code>, que asume efectos aleatorios independientes e idénticamente distribuidos. La función <span class="math inline">\(f()\)</span> tiene muchos argumentos, que se pueden consultar con el comando <code><a href="https://rdrr.io/pkg/INLA/man/f.html">?f</a></code>.</p>
<p>Veamos cómo ajustar un modelo de efectos aleatorios a partir de un ejemplo sencillo. Comenzamos con la base de datos <code>broccoli</code> en la librería <a href="https://cran.r-project.org/web/packages/faraway/faraway.pdf"><code>faraway</code></a>. Varios cultivadores suministran brócoli a una planta de procesamiento de alimentos. La planta da instrucciones a los cultivadores para que empaquen el brócoli en cajas de tamaño estándar. Debe haber 18 racimos de brócoli por caja y cada racimo debe pesar entre 1,33 y 1,5 libras. Debido a que los productores utilizan diferentes variedades, métodos de cultivo, etc., hay cierta variación en el peso de los racimos. El responsable de la planta seleccionó 3 cultivadores al azar y luego 4 cajas al azar suministradas por estos cultivadores. Se seleccionaron 3 racimos de brocoli de cada caja.</p>
<p>La variable de interés es el peso del racimo de brócoli, en la variable <code>wt</code>. Sin embargo, dado cómo se ha seleccionado la muestra, el objetivo no es ni la comparación entre cultivadores (<code>grower</code>), ni entre cajas (<code>box</code>) ni entre racimos (<code>cluster</code>). Sin embargo, de manera lógica intuimos que habrá variabilidad también entre cajas (efecto aleatorio <code>box</code>) y también entre cultivadores (efecto aleatorio <code>grower</code>), lo que nos conduce a un modelo en el que todos los predictores, <code>box</code> y <code>grower</code> intervienen como efectos aleatorios; la variable <code>cluster</code> la aprovechamos a modo de repeticiones de medidas en una misma caja de un mismo cultivador.</p>
<p>La base de datos cuenta con 36 registros (3 observaciones en cada combinación <code>grower-box</code>.</p>
<p><span class="math display">\[(y_{ijk}|\eta_{ij},\sigma^2 ) \sim N(\eta_{ijk},\sigma^2)\]</span></p>
<p>con <span class="math display">\[\eta_{ijk} = \theta + \alpha_i^G + \beta_j^B; \ \  i=2,3; j=2,3,4; k=1,2,3\]</span>
donde <span class="math inline">\(\alpha^G\)</span> representa el efecto aleatorio asociado al cultivador y <span class="math inline">\(\beta^B\)</span> a la caja.</p>
<p>Así el vector de efectos latentes está compuesto por el efecto fijo de interceptación <span class="math inline">\(theta\)</span> y los efectos aleatorios <span class="math inline">\(u=(\alpha_2^G,\alpha_3^G,\beta_2^B,\beta_3^B,\beta_4^B)\)</span>.</p>
<p>El siguiente paso es especificar una distribución a priori sobre los parámetros. INLA por defecto asigna una prior difusa sobre la interceptación <span class="math inline">\(\theta\)</span> y también sobre la precisión de los datos <span class="math inline">\(\tau=1/\sigma^2\)</span>. Dado que los <span class="math inline">\(\alpha_i^G\)</span> representan el efecto diferencial asociado al cultivador, es razonable asumir independencia entre todos estos parámetros y una distribución idéntica, centrada en el cero (ante ausencia de información) y con una varianza desconocida. Del mismo modo, se asume que los <span class="math inline">\(\beta_j^B\)</span> son a priori independientes e idénticamente distribuidos (iid) con una normal centrada en el cero (ante ausencia de información) y con varianza desconocida.</p>
<p><span class="math display">\[\begin{eqnarray*}
\theta &amp;\sim &amp; N(0,\sigma_{\theta}^2), \ \sigma_{\theta}^2=\infty \\
log(\tau) &amp;\sim &amp; Log-Ga(1,5\cdot 10^{-5})\\
\alpha_i^G &amp; \sim_{iid} &amp; N(0,\sigma_{G}^2), i=2,3 \\
\beta_j^B &amp; \sim_{iid} &amp; N(0,\sigma_{B}^2), j=2,3,4
\end{eqnarray*}\]</span></p>
<p>Surgen pues, dos nuevos parámetros en las a priori, o hiperparámetros, <span class="math inline">\(\sigma_{G}^2\)</span> y <span class="math inline">\(\sigma_{B}^2\)</span>, a los que también habrá que asignar una distribución a priori. Dado que se trata de varianzas, por defecto INLA asume gammas inversas difusas, o lo que es lo mismo, log-gammas difusas para las precisiones</p>
<p><span class="math display">\[\begin{eqnarray*}
\tau_{G}=1/\sigma_{G}^2 &amp;\sim &amp; Ga(1,5\cdot 10^{-5}) \\
\tau_{B}=1/\sigma_{B}^2 &amp;\sim &amp; Ga(1,5\cdot 10^{-5})
\end{eqnarray*}\]</span></p>
<p>Surgen pues, tres niveles de especificación del modelo: datos, parámetros e hiperparámetros, que generan un modelo jerárquico, y sobre el que hablaremos más adelante.</p>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">broccoli</span>, package<span class="op">=</span><span class="st">"faraway"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">broccoli</span><span class="op">)</span></span>
<span><span class="co">#&gt; 'data.frame':    36 obs. of  4 variables:</span></span>
<span><span class="co">#&gt;  $ wt     : num  352 369 383 339 367 328 376 359 388 365 ...</span></span>
<span><span class="co">#&gt;  $ grower : Factor w/ 3 levels "1","2","3": 1 1 1 2 2 2 3 3 3 1 ...</span></span>
<span><span class="co">#&gt;  $ box    : Factor w/ 4 levels "1","2","3","4": 1 1 1 1 1 1 1 1 1 2 ...</span></span>
<span><span class="co">#&gt;  $ cluster: Factor w/ 3 levels "1","2","3": 1 2 3 1 2 3 1 2 3 1 ...</span></span>
<span><span class="va">formula</span> <span class="op">=</span> <span class="va">wt</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html">f</a></span><span class="op">(</span><span class="va">grower</span>,model<span class="op">=</span><span class="st">"iid"</span><span class="op">)</span><span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html">f</a></span><span class="op">(</span><span class="va">box</span>,model<span class="op">=</span><span class="st">"iid"</span><span class="op">)</span></span>
<span><span class="va">fit</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.html">inla</a></span><span class="op">(</span><span class="va">formula</span>, family<span class="op">=</span><span class="st">"gaussian"</span>,data<span class="op">=</span><span class="va">broccoli</span>,</span>
<span>           control.compute <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>dic<span class="op">=</span><span class="cn">TRUE</span>,waic<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>  </span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt;    c("inla.core(formula = formula, family = family, </span></span>
<span><span class="co">#&gt;    contrasts = contrasts, ", " data = data, quantiles = </span></span>
<span><span class="co">#&gt;    quantiles, E = E, offset = offset, ", " scale = </span></span>
<span><span class="co">#&gt;    scale, weights = weights, Ntrials = Ntrials, strata = </span></span>
<span><span class="co">#&gt;    strata, ", " lp.scale = lp.scale, link.covariates = </span></span>
<span><span class="co">#&gt;    link.covariates, verbose = verbose, ", " lincomb = </span></span>
<span><span class="co">#&gt;    lincomb, selection = selection, control.compute = </span></span>
<span><span class="co">#&gt;    control.compute, ", " control.predictor = </span></span>
<span><span class="co">#&gt;    control.predictor, control.family = control.family, </span></span>
<span><span class="co">#&gt;    ", " control.inla = control.inla, control.fixed = </span></span>
<span><span class="co">#&gt;    control.fixed, ", " control.mode = control.mode, </span></span>
<span><span class="co">#&gt;    control.expert = control.expert, ", " control.hazard </span></span>
<span><span class="co">#&gt;    = control.hazard, control.lincomb = control.lincomb, </span></span>
<span><span class="co">#&gt;    ", " control.update = control.update, </span></span>
<span><span class="co">#&gt;    control.lp.scale = control.lp.scale, ", " </span></span>
<span><span class="co">#&gt;    control.pardiso = control.pardiso, only.hyperparam = </span></span>
<span><span class="co">#&gt;    only.hyperparam, ", " inla.call = inla.call, inla.arg </span></span>
<span><span class="co">#&gt;    = inla.arg, num.threads = num.threads, ", " </span></span>
<span><span class="co">#&gt;    blas.num.threads = blas.num.threads, keep = keep, </span></span>
<span><span class="co">#&gt;    working.directory = working.directory, ", " silent = </span></span>
<span><span class="co">#&gt;    silent, inla.mode = inla.mode, safe = FALSE, debug = </span></span>
<span><span class="co">#&gt;    debug, ", " .parent.frame = .parent.frame)") </span></span>
<span><span class="co">#&gt; Time used:</span></span>
<span><span class="co">#&gt;     Pre = 2.47, Running = 0.253, Post = 0.0177, Total = 2.74 </span></span>
<span><span class="co">#&gt; Fixed effects:</span></span>
<span><span class="co">#&gt;                mean    sd 0.025quant 0.5quant 0.975quant</span></span>
<span><span class="co">#&gt; (Intercept) 358.167 2.794    352.663  358.167     363.67</span></span>
<span><span class="co">#&gt;             mode kld</span></span>
<span><span class="co">#&gt; (Intercept)   NA   0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Random effects:</span></span>
<span><span class="co">#&gt;   Name     Model</span></span>
<span><span class="co">#&gt;     grower IID model</span></span>
<span><span class="co">#&gt;    box IID model</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Model hyperparameters:</span></span>
<span><span class="co">#&gt;                                             mean       sd</span></span>
<span><span class="co">#&gt; Precision for the Gaussian observations 4.00e-03 1.00e-03</span></span>
<span><span class="co">#&gt; Precision for grower                    2.79e+04 3.10e+04</span></span>
<span><span class="co">#&gt; Precision for box                       2.19e+04 1.12e+04</span></span>
<span><span class="co">#&gt;                                         0.025quant 0.5quant</span></span>
<span><span class="co">#&gt; Precision for the Gaussian observations      0.002 4.00e-03</span></span>
<span><span class="co">#&gt; Precision for grower                      3824.119 1.86e+04</span></span>
<span><span class="co">#&gt; Precision for box                         7074.457 1.96e+04</span></span>
<span><span class="co">#&gt;                                         0.975quant mode</span></span>
<span><span class="co">#&gt; Precision for the Gaussian observations   6.00e-03   NA</span></span>
<span><span class="co">#&gt; Precision for grower                      1.08e+05   NA</span></span>
<span><span class="co">#&gt; Precision for box                         4.99e+04   NA</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Deviance Information Criterion (DIC) ...............: 307.71</span></span>
<span><span class="co">#&gt; Deviance Information Criterion (DIC, saturated) ....: 26088.91</span></span>
<span><span class="co">#&gt; Effective number of parameters .....................: 1.86</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Watanabe-Akaike information criterion (WAIC) ...: 307.55</span></span>
<span><span class="co">#&gt; Effective number of parameters .................: 1.61</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Marginal log-Likelihood:  -169.00 </span></span>
<span><span class="co">#&gt;  is computed </span></span>
<span><span class="co">#&gt; Posterior summaries for the linear predictor and the fitted values are computed</span></span>
<span><span class="co">#&gt; (Posterior marginals needs also 'control.compute=list(return.marginals.predictor=TRUE)')</span></span></code></pre></div>
<p>Cuando queremos mostrar los resultados a posteriori sobre los efectos aleatorios a partir de un ajuste <code>fit</code> con <code>inla</code>, tenemos las siguientes opciones:</p>
<ul>
<li>
<code>fit$summary.random</code> resume la inferencia posterior sobre los efectos
aleatorios</li>
<li>
<code>names(fit$marginals.random)</code> lista los nombre de todos los efectos aleatorios</li>
<li>
<code>fit$marginals.random</code> da las distribuciones posteriores marginales de los efectos aleatorios</li>
</ul>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span><span class="op">$</span><span class="va">summary.random</span></span>
<span><span class="co">#&gt; $grower</span></span>
<span><span class="co">#&gt;   ID          mean          sd  0.025quant      0.5quant</span></span>
<span><span class="co">#&gt; 1  1  1.093628e-06 0.009821113 -0.02064187  7.726628e-07</span></span>
<span><span class="co">#&gt; 2  2 -7.654968e-06 0.009821115 -0.02065680 -5.408375e-06</span></span>
<span><span class="co">#&gt; 3  3  6.561501e-06 0.009821114 -0.02063255  4.635813e-06</span></span>
<span><span class="co">#&gt;   0.975quant mode          kld</span></span>
<span><span class="co">#&gt; 1 0.02064560   NA 4.989585e-06</span></span>
<span><span class="co">#&gt; 2 0.02063068   NA 4.989610e-06</span></span>
<span><span class="co">#&gt; 3 0.02065493   NA 4.989603e-06</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $box</span></span>
<span><span class="co">#&gt;   ID          mean          sd  0.025quant      0.5quant</span></span>
<span><span class="co">#&gt; 1  1  8.472212e-06 0.007886235 -0.01601923  7.337646e-06</span></span>
<span><span class="co">#&gt; 2  2 -4.857389e-06 0.007886235 -0.01603760 -4.206905e-06</span></span>
<span><span class="co">#&gt; 3  3 -2.146297e-06 0.007886234 -0.01603387 -1.858871e-06</span></span>
<span><span class="co">#&gt; 4  4 -1.468509e-06 0.007886234 -0.01603293 -1.271851e-06</span></span>
<span><span class="co">#&gt;   0.975quant mode          kld</span></span>
<span><span class="co">#&gt; 1 0.01604259   NA 1.629850e-08</span></span>
<span><span class="co">#&gt; 2 0.01602421   NA 1.629825e-08</span></span>
<span><span class="co">#&gt; 3 0.01602795   NA 1.629816e-08</span></span>
<span><span class="co">#&gt; 4 0.01602888   NA 1.629814e-08</span></span></code></pre></div>
<p>Más que la inferencia sobre los efectos aleatorios, es importante la que se hace sobre las varianzas asociadas:</p>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span><span class="op">$</span><span class="va">summary.hyperpar</span></span>
<span><span class="co">#&gt;                                                 mean</span></span>
<span><span class="co">#&gt; Precision for the Gaussian observations 3.817327e-03</span></span>
<span><span class="co">#&gt; Precision for grower                    2.785806e+04</span></span>
<span><span class="co">#&gt; Precision for box                       2.187930e+04</span></span>
<span><span class="co">#&gt;                                                   sd</span></span>
<span><span class="co">#&gt; Precision for the Gaussian observations 1.069895e-03</span></span>
<span><span class="co">#&gt; Precision for grower                    3.095648e+04</span></span>
<span><span class="co">#&gt; Precision for box                       1.121912e+04</span></span>
<span><span class="co">#&gt;                                           0.025quant</span></span>
<span><span class="co">#&gt; Precision for the Gaussian observations 2.090811e-03</span></span>
<span><span class="co">#&gt; Precision for grower                    3.824119e+03</span></span>
<span><span class="co">#&gt; Precision for box                       7.074457e+03</span></span>
<span><span class="co">#&gt;                                             0.5quant</span></span>
<span><span class="co">#&gt; Precision for the Gaussian observations 3.695988e-03</span></span>
<span><span class="co">#&gt; Precision for grower                    1.859350e+04</span></span>
<span><span class="co">#&gt; Precision for box                       1.963688e+04</span></span>
<span><span class="co">#&gt;                                           0.975quant mode</span></span>
<span><span class="co">#&gt; Precision for the Gaussian observations 6.258816e-03   NA</span></span>
<span><span class="co">#&gt; Precision for grower                    1.077460e+05   NA</span></span>
<span><span class="co">#&gt; Precision for box                       4.986615e+04   NA</span></span></code></pre></div>
<p>Vemos que tanto la precisión asociada al efecto aleatorio caja (<code>box</code>), como al efecto cultivador, <code>grower</code>, son muy grandes, lo que implica varianzas muy pequeñas que posiblemente nos permita prescindir de dichos efectos aleatorios para ajustar un mejor modelo.Cuando transformamos a escala de desviaciones estándar, tenemos la distribución posterior para los tres tipo de error (en la Figura <a href="anova.html#fig:brocoli2">3.8</a>).</p>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nombres</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sigma"</span>,<span class="st">"grower"</span>,<span class="st">"box"</span><span class="op">)</span></span>
<span><span class="va">sigma.post</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/INLA/man/marginal.html">inla.tmarginal</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">tau</span><span class="op">)</span> <span class="va">tau</span><span class="op">^</span><span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>  <span class="va">fit</span><span class="op">$</span><span class="va">marginals.hyperpar</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sigma.grower.post</span> <span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/INLA/man/marginal.html">inla.tmarginal</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">tau</span><span class="op">)</span> <span class="va">tau</span><span class="op">^</span><span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>  <span class="va">fit</span><span class="op">$</span><span class="va">marginals.hyperpar</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sigma.box.post</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/INLA/man/marginal.html">inla.tmarginal</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">tau</span><span class="op">)</span> <span class="va">tau</span><span class="op">^</span><span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>  <span class="va">fit</span><span class="op">$</span><span class="va">marginals.hyperpar</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sigma</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">sigma.post</span>,<span class="va">sigma.grower.post</span>,<span class="va">sigma.box.post</span><span class="op">)</span></span>
<span><span class="va">sigma</span><span class="op">$</span><span class="va">efecto</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sigma"</span>,<span class="st">"grower"</span>,<span class="st">"box"</span><span class="op">)</span>,</span>
<span>                 <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">sigma.post</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">sigma.grower.post</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">sigma.box.post</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> </span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">sigma</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x</span>,y<span class="op">=</span><span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>color<span class="op">=</span><span class="va">efecto</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="va">sigma</span><span class="op">)</span>,y<span class="op">=</span><span class="st">"D.Posterior"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html">vars</a></span><span class="op">(</span><span class="va">efecto</span><span class="op">)</span>,scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">45</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:brocoli2"></span>
<img src="02-anova_files/figure-html/brocoli2-1.png" alt="Distribución posterior de la desviación típica para las tres fuentes de error: datos, caja y cultivador" width="672"><p class="caption">
Figura 3.8: Distribución posterior de la desviación típica para las tres fuentes de error: datos, caja y cultivador
</p>
</div>
<p>No obstante, antes de tomar una decisión sobre la exclusión de los efectos aleatorios, vamos a hacer una aproximación del porcentaje de varianza explicada por cada una de estas fuentes de variación. Utilizando simulaciones de las distribuciones posteriores de <span class="math inline">\(\sigma^2, \sigma_{G}^2\)</span> y <span class="math inline">\(\sigma_{B}^2\)</span> vamos a calcular la contribución a la varianza del efecto cultivador, $ <em>{G}<sup>2/(</sup>2 + </em>{G}^2)$ y la contribución a la varianza del efecto caja, $ <em>{B}<sup>2/(</sup>2 + </em>{B}^2)$, y calcular con ellas un porcentaje promedio.</p>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n</span><span class="op">=</span><span class="fl">1000</span></span>
<span><span class="va">tau</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/INLA/man/sampler.html">inla.hyperpar.sample</a></span><span class="op">(</span><span class="va">n</span>,<span class="va">fit</span>,improve.marginals<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sigma2</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">tau</span>,<span class="fl">2</span>,<span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fl">1</span><span class="op">/</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">sigma2</span><span class="op">)</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sigma2d"</span>,<span class="st">"sigma2G"</span>,<span class="st">"sigma2B"</span><span class="op">)</span></span>
<span><span class="co"># contribución a la varianza de grower</span></span>
<span><span class="va">cG</span><span class="op">=</span> <span class="va">sigma2</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">sigma2</span>,<span class="fl">1</span>,<span class="va">sum</span><span class="op">)</span></span>
<span><span class="co"># contribución a la varianza de grower</span></span>
<span><span class="va">cB</span><span class="op">=</span> <span class="va">sigma2</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">sigma2</span>,<span class="fl">1</span>,<span class="va">sum</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Contribución media de grower a la varianza:"</span>,<span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">cG</span><span class="op">)</span><span class="op">*</span><span class="fl">100</span>,<span class="fl">6</span><span class="op">)</span>,<span class="st">"por 100"</span>,<span class="st">"\n"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Contribución media de grower a la varianza: 2.9e-05 por 100</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Contribución media de box a la varianza:"</span>,<span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">cB</span><span class="op">)</span><span class="op">*</span><span class="fl">100</span>,<span class="fl">6</span><span class="op">)</span>,<span class="st">"por 100"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Contribución media de box a la varianza: 2.1e-05 por 100</span></span></code></pre></div>
<p>Ante estos resultados, y dados los valores del DIC (307.7120056) y del WAIC (307.547971), se justifica la opción de prescindir de los efectos <code>grower</code> y <code>box</code> como efectos aleatorios y ajustar el modelo con un único efecto fijo global.</p>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">formula</span> <span class="op">=</span> <span class="va">wt</span> <span class="op">~</span> <span class="fl">1</span></span>
<span><span class="va">fit</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.html">inla</a></span><span class="op">(</span><span class="va">formula</span>, family<span class="op">=</span><span class="st">"gaussian"</span>,data<span class="op">=</span><span class="va">broccoli</span>,</span>
<span>           control.compute <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>dic<span class="op">=</span><span class="cn">TRUE</span>,waic<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>  </span>
<span><span class="va">fit</span><span class="op">$</span><span class="va">summary.fixed</span></span>
<span><span class="co">#&gt;                 mean       sd 0.025quant 0.5quant</span></span>
<span><span class="co">#&gt; (Intercept) 358.1667 2.805636    352.633 358.1667</span></span>
<span><span class="co">#&gt;             0.975quant mode          kld</span></span>
<span><span class="co">#&gt; (Intercept)   363.7003   NA 1.113798e-08</span></span>
<span><span class="va">fit</span><span class="op">$</span><span class="va">summary.hyperpar</span></span>
<span><span class="co">#&gt;                                                mean</span></span>
<span><span class="co">#&gt; Precision for the Gaussian observations 0.003780104</span></span>
<span><span class="co">#&gt;                                                   sd</span></span>
<span><span class="co">#&gt; Precision for the Gaussian observations 0.0008806289</span></span>
<span><span class="co">#&gt;                                          0.025quant</span></span>
<span><span class="co">#&gt; Precision for the Gaussian observations 0.002256112</span></span>
<span><span class="co">#&gt;                                            0.5quant</span></span>
<span><span class="co">#&gt; Precision for the Gaussian observations 0.003702778</span></span>
<span><span class="co">#&gt;                                         0.975quant mode</span></span>
<span><span class="co">#&gt; Precision for the Gaussian observations 0.00571564   NA</span></span></code></pre></div>
<p>Vemos que la variación en los indicadores DIC (307.8624344) y WAIC (307.878547) es despreciable para este nuevo modelo.</p>
<p>Inferimos a continuación con las posteriores para la media global y la varianza de los datos.</p>
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">theta.post</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">marginals.fixed</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">sigma.post</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/INLA/man/marginal.html">inla.tmarginal</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">tau</span><span class="op">)</span> <span class="va">tau</span><span class="op">^</span><span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>  <span class="va">fit</span><span class="op">$</span><span class="va">marginals.hyperpar</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">posterior</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">theta.post</span>,<span class="va">sigma.post</span><span class="op">)</span></span>
<span><span class="va">posterior</span><span class="op">$</span><span class="va">efecto</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"theta"</span>,<span class="st">"sigma"</span><span class="op">)</span>,</span>
<span>                     <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">theta.post</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">sigma.post</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">posterior</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x</span>,y<span class="op">=</span><span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>color<span class="op">=</span><span class="va">efecto</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x<span class="op">=</span><span class="st">""</span>,y<span class="op">=</span><span class="st">"D.Posterior"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html">vars</a></span><span class="op">(</span><span class="va">efecto</span><span class="op">)</span>,scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="02-anova_files/figure-html/unnamed-chunk-24-1.png" width="672"></div>
</div>
<div id="modelos-mixtos" class="section level2" number="3.7">
<h2>
<span class="header-section-number">3.7</span> Modelos mixtos<a class="anchor" aria-label="anchor" href="#modelos-mixtos"><i class="fas fa-link"></i></a>
</h2>
<p>En ocasiones cuando ajustamos un modelo lineal tendremos algunos factores de clasificación que operan como efectos fijos y otros que operan como efectos aleatorios. Estaremos ante <strong>modelos lineales mixtos</strong>. Siendo estrictos, realmente el modelo con solo efectos aleatorios ya es un modelo mixto, puesto que incluye como efecto fijo una interceptación global.</p>
<p>En un modelo lineal mixto seguimos asumiendo una respuesta normal, <em>gaussian</em>, con media igual a un predictor lineal <span class="math inline">\(\eta=X\beta + Z u\)</span>, donde <span class="math inline">\(X\)</span> es una matriz de diseño con los efectos fijos <span class="math inline">\(x_1,x_2,...\)</span>, y <span class="math inline">\(Z\)</span> la correspondiente para los efectos aleatorios <span class="math inline">\(z_1, z_2,...\)</span>. Se asume además una varianza desconocida que puede ser distinta para distintos niveles de los predictores, y que en general se suele expresar a través de una matriz de covarianzas <span class="math inline">\(\Sigma\)</span>, <span class="math inline">\((y|\eta,\Sigma) \sim N(\eta,\Sigma)\)</span>.</p>
<p>En INLA la fórmula de predicción de una respuesta <span class="math inline">\(y\)</span> a partir de un conjunto de efectos fijos x1,x2,…, y un conjunto de efectos aleatorios z1,z2,… se especifica como:</p>
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">formula</span> <span class="op">=</span> <span class="va">y</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">x1</span> <span class="op">+</span> <span class="va">x2</span>  <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html">f</a></span><span class="op">(</span><span class="va">z1</span>, model<span class="op">=</span><span class="st">""</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html">f</a></span><span class="op">(</span><span class="va">z2</span>,model<span class="op">=</span><span class="st">""</span><span class="op">)</span> </span></code></pre></div>
<p>De nuevo mencionar que la opción más habitual para los efectos aleatorios en un modelo lineal es <code>model="iid"</code>.</p>
<p>Veamos cómo resolver las inferencias con la base de datos <code>penicillin</code> en la librería (<code>faraway</code>](<a href="https://cran.r-project.org/web/packages/faraway/faraway.pdf" class="uri">https://cran.r-project.org/web/packages/faraway/faraway.pdf</a>). Se recogen datos de la producción de penicilina (<code>yield</code>) para cuatro procesos de fabricación distintos (<code>treat</code>) y con varias mezclas de la materia prima, que son bastante variables. El objetivo es investigar las diferencias entre los procesos de fabricación, pero teniendo en cuenta la variabilidad extra que podrían introducir las mezclas. Es decir, estamos pensando en un modelo lineal para predecir <code>yield</code>, en el que <code>treat</code> interviene como efecto fijo y <code>blend</code> como efecto aleatorio.</p>
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">penicillin</span>,package<span class="op">=</span><span class="st">"faraway"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">penicillin</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">treat</span>,y<span class="op">=</span><span class="va">yield</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>color<span class="op">=</span><span class="va">blend</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure">
<img src="02-anova_files/figure-html/unnamed-chunk-26-1.png" width="672">
Modelizamos pues con INLA:</div>
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">penicillin</span><span class="op">$</span><span class="va">treat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/relevel.html">relevel</a></span><span class="op">(</span><span class="va">penicillin</span><span class="op">$</span><span class="va">treat</span>,<span class="st">"D"</span><span class="op">)</span></span>
<span><span class="va">prec.prior</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>prec<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>param <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.001</span>, <span class="fl">0.001</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">formula</span> <span class="op">=</span> <span class="va">yield</span> <span class="op">~</span> <span class="op">-</span><span class="fl">1</span><span class="op">+</span> <span class="va">treat</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html">f</a></span><span class="op">(</span><span class="va">blend</span>,model<span class="op">=</span><span class="st">"iid"</span>,hyper<span class="op">=</span><span class="va">prec.prior</span><span class="op">)</span></span>
<span><span class="va">fit</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.html">inla</a></span><span class="op">(</span><span class="va">formula</span>,family<span class="op">=</span><span class="st">"gaussian"</span>,data<span class="op">=</span><span class="va">penicillin</span>,</span>
<span>         control.predictor<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>compute<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>         control.compute<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>dic<span class="op">=</span><span class="cn">TRUE</span>,waic<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">fit</span><span class="op">$</span><span class="va">summary.fixed</span></span>
<span><span class="co">#&gt;            mean       sd 0.025quant 0.5quant 0.975quant</span></span>
<span><span class="co">#&gt; treatD 85.47452 2.478418   80.47504 85.50369   90.30280</span></span>
<span><span class="co">#&gt; treatA 83.48674 2.478096   78.48990 83.51523   88.31638</span></span>
<span><span class="co">#&gt; treatB 84.48063 2.478256   79.48247 84.50946   89.30959</span></span>
<span><span class="co">#&gt; treatC 88.45619 2.478913   83.45274 88.48638   93.28246</span></span>
<span><span class="co">#&gt;        mode          kld</span></span>
<span><span class="co">#&gt; treatD   NA 5.237354e-09</span></span>
<span><span class="co">#&gt; treatA   NA 4.913986e-09</span></span>
<span><span class="co">#&gt; treatB   NA 5.073750e-09</span></span>
<span><span class="co">#&gt; treatC   NA 5.752827e-09</span></span>
<span><span class="va">fit</span><span class="op">$</span><span class="va">summary.random</span></span>
<span><span class="co">#&gt; $blend</span></span>
<span><span class="co">#&gt;       ID          mean         sd  0.025quant      0.5quant</span></span>
<span><span class="co">#&gt; 1 Blend1  2.306201e-04 0.01541138 -0.03196148  9.653375e-05</span></span>
<span><span class="co">#&gt; 2 Blend2 -9.035004e-05 0.01540310 -0.03308159 -3.771342e-05</span></span>
<span><span class="co">#&gt; 3 Blend3 -1.904258e-05 0.01540162 -0.03282735 -7.919387e-06</span></span>
<span><span class="co">#&gt; 4 Blend4  8.791531e-05 0.01540295 -0.03245180  3.674806e-05</span></span>
<span><span class="co">#&gt; 5 Blend5 -1.260116e-04 0.01540455 -0.03320991 -5.263564e-05</span></span>
<span><span class="co">#&gt;   0.975quant mode        kld</span></span>
<span><span class="co">#&gt; 1 0.03359012   NA 0.03833797</span></span>
<span><span class="co">#&gt; 2 0.03244311   NA 0.03800576</span></span>
<span><span class="co">#&gt; 3 0.03269251   NA 0.03794779</span></span>
<span><span class="co">#&gt; 4 0.03307240   NA 0.03800203</span></span>
<span><span class="co">#&gt; 5 0.03231954   NA 0.03806298</span></span>
<span><span class="va">fit</span><span class="op">$</span><span class="va">summary.hyperpar</span></span>
<span><span class="co">#&gt;                                                 mean</span></span>
<span><span class="co">#&gt; Precision for the Gaussian observations 3.630967e-02</span></span>
<span><span class="co">#&gt; Precision for blend                     2.144700e+04</span></span>
<span><span class="co">#&gt;                                                   sd</span></span>
<span><span class="co">#&gt; Precision for the Gaussian observations 1.242357e-02</span></span>
<span><span class="co">#&gt; Precision for blend                     2.219497e+04</span></span>
<span><span class="co">#&gt;                                           0.025quant</span></span>
<span><span class="co">#&gt; Precision for the Gaussian observations 1.694877e-02</span></span>
<span><span class="co">#&gt; Precision for blend                     1.691562e+03</span></span>
<span><span class="co">#&gt;                                             0.5quant</span></span>
<span><span class="co">#&gt; Precision for the Gaussian observations 3.468284e-02</span></span>
<span><span class="co">#&gt; Precision for blend                     1.482978e+04</span></span>
<span><span class="co">#&gt;                                           0.975quant mode</span></span>
<span><span class="co">#&gt; Precision for the Gaussian observations 6.526480e-02   NA</span></span>
<span><span class="co">#&gt; Precision for blend                     8.028692e+04   NA</span></span>
<span><span class="va">fit</span><span class="op">$</span><span class="va">dic</span><span class="op">$</span><span class="va">dic</span>; <span class="va">fit</span><span class="op">$</span><span class="va">waic</span><span class="op">$</span><span class="va">waic</span></span>
<span><span class="co">#&gt; [1] 131.3037</span></span>
<span><span class="co">#&gt; [1] 131.4688</span></span></code></pre></div>
<p>Representamos en la figura <a href="#fig:penicillin2"><strong>??</strong></a> las distribuciones posteriores de los efectos fijos y de los efectos aleatorios.</p>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fixed</span><span class="op">=</span><span class="cn">NULL</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">fixed</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">fixed</span>,<span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">marginals.fixed</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">fixed</span></span>
<span><span class="co">#&gt;             x            y</span></span>
<span><span class="co">#&gt; 1    73.33080 3.356617e-05</span></span>
<span><span class="co">#&gt; 2    74.62733 1.216167e-04</span></span>
<span><span class="co">#&gt; 3    76.84414 9.552352e-04</span></span>
<span><span class="co">#&gt; 4    79.37687 8.596629e-03</span></span>
<span><span class="co">#&gt; 5    80.47504 2.013795e-02</span></span>
<span><span class="co">#&gt; 6    81.36589 3.743803e-02</span></span>
<span><span class="co">#&gt; 7    82.34131 6.711385e-02</span></span>
<span><span class="co">#&gt; 8    82.97378 9.183890e-02</span></span>
<span><span class="co">#&gt; 9    83.46442 1.125020e-01</span></span>
<span><span class="co">#&gt; 10   83.87829 1.295807e-01</span></span>
<span><span class="co">#&gt; 11   84.24532 1.433673e-01</span></span>
<span><span class="co">#&gt; 12   84.58216 1.540495e-01</span></span>
<span><span class="co">#&gt; 13   84.74271 1.582677e-01</span></span>
<span><span class="co">#&gt; 14   84.89940 1.617519e-01</span></span>
<span><span class="co">#&gt; 15   85.05312 1.645099e-01</span></span>
<span><span class="co">#&gt; 16   85.20461 1.665469e-01</span></span>
<span><span class="co">#&gt; 17   85.26473 1.671606e-01</span></span>
<span><span class="co">#&gt; 18   85.32466 1.676598e-01</span></span>
<span><span class="co">#&gt; 19   85.35457 1.678664e-01</span></span>
<span><span class="co">#&gt; 20   85.38445 1.680444e-01</span></span>
<span><span class="co">#&gt; 21   85.44411 1.683144e-01</span></span>
<span><span class="co">#&gt; 22   85.50369 1.684696e-01</span></span>
<span><span class="co">#&gt; 23   85.56324 1.685101e-01</span></span>
<span><span class="co">#&gt; 24   85.62281 1.684357e-01</span></span>
<span><span class="co">#&gt; 25   85.65260 1.683553e-01</span></span>
<span><span class="co">#&gt; 26   85.68241 1.682461e-01</span></span>
<span><span class="co">#&gt; 27   85.74210 1.679412e-01</span></span>
<span><span class="co">#&gt; 28   85.80192 1.675205e-01</span></span>
<span><span class="co">#&gt; 29   85.95231 1.659598e-01</span></span>
<span><span class="co">#&gt; 30   86.10448 1.636652e-01</span></span>
<span><span class="co">#&gt; 31   86.25913 1.606266e-01</span></span>
<span><span class="co">#&gt; 32   86.41710 1.568321e-01</span></span>
<span><span class="co">#&gt; 33   86.74695 1.469093e-01</span></span>
<span><span class="co">#&gt; 34   87.10396 1.337208e-01</span></span>
<span><span class="co">#&gt; 35   87.50356 1.170154e-01</span></span>
<span><span class="co">#&gt; 36   87.97325 9.640853e-02</span></span>
<span><span class="co">#&gt; 37   88.57246 7.127482e-02</span></span>
<span><span class="co">#&gt; 38   89.48346 4.043227e-02</span></span>
<span><span class="co">#&gt; 39   90.30280 2.204670e-02</span></span>
<span><span class="co">#&gt; 40   91.29884 9.539238e-03</span></span>
<span><span class="co">#&gt; 41   93.56650 1.064911e-03</span></span>
<span><span class="co">#&gt; 42   95.63550 1.178312e-04</span></span>
<span><span class="co">#&gt; 43   97.23764 2.023824e-05</span></span>
<span><span class="co">#&gt; 44   71.34753 3.335700e-05</span></span>
<span><span class="co">#&gt; 45   72.64797 1.215006e-04</span></span>
<span><span class="co">#&gt; 46   74.86365 9.563992e-04</span></span>
<span><span class="co">#&gt; 47   77.39306 8.607704e-03</span></span>
<span><span class="co">#&gt; 48   78.48990 2.016120e-02</span></span>
<span><span class="co">#&gt; 49   79.37978 3.747565e-02</span></span>
<span><span class="co">#&gt; 50   80.35431 6.716845e-02</span></span>
<span><span class="co">#&gt; 51   80.98631 9.190124e-02</span></span>
<span><span class="co">#&gt; 52   81.47665 1.125663e-01</span></span>
<span><span class="co">#&gt; 53   81.89031 1.296427e-01</span></span>
<span><span class="co">#&gt; 54   82.25717 1.434240e-01</span></span>
<span><span class="co">#&gt; 55   82.59390 1.540987e-01</span></span>
<span><span class="co">#&gt; 56   82.75440 1.583124e-01</span></span>
<span><span class="co">#&gt; 57   82.91105 1.617919e-01</span></span>
<span><span class="co">#&gt; 58   83.06473 1.645448e-01</span></span>
<span><span class="co">#&gt; 59   83.21619 1.665766e-01</span></span>
<span><span class="co">#&gt; 60   83.27631 1.671881e-01</span></span>
<span><span class="co">#&gt; 61   83.33623 1.676851e-01</span></span>
<span><span class="co">#&gt; 62   83.36613 1.678906e-01</span></span>
<span><span class="co">#&gt; 63   83.39600 1.680675e-01</span></span>
<span><span class="co">#&gt; 64   83.45566 1.683352e-01</span></span>
<span><span class="co">#&gt; 65   83.51523 1.684882e-01</span></span>
<span><span class="co">#&gt; 66   83.57478 1.685265e-01</span></span>
<span><span class="co">#&gt; 67   83.63434 1.684497e-01</span></span>
<span><span class="co">#&gt; 68   83.66413 1.683682e-01</span></span>
<span><span class="co">#&gt; 69   83.69393 1.682579e-01</span></span>
<span><span class="co">#&gt; 70   83.75362 1.679507e-01</span></span>
<span><span class="co">#&gt; 71   83.81344 1.675276e-01</span></span>
<span><span class="co">#&gt; 72   83.96383 1.659612e-01</span></span>
<span><span class="co">#&gt; 73   84.11599 1.636610e-01</span></span>
<span><span class="co">#&gt; 74   84.27065 1.606169e-01</span></span>
<span><span class="co">#&gt; 75   84.42863 1.568170e-01</span></span>
<span><span class="co">#&gt; 76   84.75852 1.468841e-01</span></span>
<span><span class="co">#&gt; 77   85.11561 1.336871e-01</span></span>
<span><span class="co">#&gt; 78   85.51532 1.169753e-01</span></span>
<span><span class="co">#&gt; 79   85.98521 9.636532e-02</span></span>
<span><span class="co">#&gt; 80   86.58472 7.123336e-02</span></span>
<span><span class="co">#&gt; 81   87.49634 4.040080e-02</span></span>
<span><span class="co">#&gt; 82   88.31638 2.202591e-02</span></span>
<span><span class="co">#&gt; 83   89.31345 9.528591e-03</span></span>
<span><span class="co">#&gt; 84   91.58393 1.063544e-03</span></span>
<span><span class="co">#&gt; 85   93.65513 1.177992e-04</span></span>
<span><span class="co">#&gt; 86   95.25456 2.033987e-05</span></span>
<span><span class="co">#&gt; 87   72.33916 3.346146e-05</span></span>
<span><span class="co">#&gt; 88   73.63765 1.215585e-04</span></span>
<span><span class="co">#&gt; 89   75.85390 9.558165e-04</span></span>
<span><span class="co">#&gt; 90   78.38497 8.602162e-03</span></span>
<span><span class="co">#&gt; 91   79.48247 2.014957e-02</span></span>
<span><span class="co">#&gt; 92   80.37284 3.745683e-02</span></span>
<span><span class="co">#&gt; 93   81.34781 6.714115e-02</span></span>
<span><span class="co">#&gt; 94   81.98005 9.187008e-02</span></span>
<span><span class="co">#&gt; 95   82.47053 1.125342e-01</span></span>
<span><span class="co">#&gt; 96   82.88430 1.296117e-01</span></span>
<span><span class="co">#&gt; 97   83.25125 1.433957e-01</span></span>
<span><span class="co">#&gt; 98   83.58803 1.540741e-01</span></span>
<span><span class="co">#&gt; 99   83.74855 1.582901e-01</span></span>
<span><span class="co">#&gt; 100  83.90522 1.617719e-01</span></span>
<span><span class="co">#&gt; 101  84.05893 1.645274e-01</span></span>
<span><span class="co">#&gt; 102  84.21040 1.665618e-01</span></span>
<span><span class="co">#&gt; 103  84.27052 1.671744e-01</span></span>
<span><span class="co">#&gt; 104  84.33045 1.676725e-01</span></span>
<span><span class="co">#&gt; 105  84.36035 1.678785e-01</span></span>
<span><span class="co">#&gt; 106  84.39023 1.680560e-01</span></span>
<span><span class="co">#&gt; 107  84.44989 1.683249e-01</span></span>
<span><span class="co">#&gt; 108  84.50946 1.684790e-01</span></span>
<span><span class="co">#&gt; 109  84.56901 1.685183e-01</span></span>
<span><span class="co">#&gt; 110  84.62857 1.684427e-01</span></span>
<span><span class="co">#&gt; 111  84.65837 1.683618e-01</span></span>
<span><span class="co">#&gt; 112  84.68817 1.682520e-01</span></span>
<span><span class="co">#&gt; 113  84.74786 1.679460e-01</span></span>
<span><span class="co">#&gt; 114  84.80768 1.675241e-01</span></span>
<span><span class="co">#&gt; 115  84.95807 1.659605e-01</span></span>
<span><span class="co">#&gt; 116  85.11023 1.636631e-01</span></span>
<span><span class="co">#&gt; 117  85.26489 1.606218e-01</span></span>
<span><span class="co">#&gt; 118  85.42286 1.568246e-01</span></span>
<span><span class="co">#&gt; 119  85.75273 1.468967e-01</span></span>
<span><span class="co">#&gt; 120  86.10978 1.337039e-01</span></span>
<span><span class="co">#&gt; 121  86.50944 1.169954e-01</span></span>
<span><span class="co">#&gt; 122  86.97923 9.638694e-02</span></span>
<span><span class="co">#&gt; 123  87.57859 7.125410e-02</span></span>
<span><span class="co">#&gt; 124  88.48990 4.041654e-02</span></span>
<span><span class="co">#&gt; 125  89.30959 2.203631e-02</span></span>
<span><span class="co">#&gt; 126  90.30615 9.533912e-03</span></span>
<span><span class="co">#&gt; 127  92.57522 1.064227e-03</span></span>
<span><span class="co">#&gt; 128  94.64531 1.178150e-04</span></span>
<span><span class="co">#&gt; 129  96.24610 2.028892e-05</span></span>
<span><span class="co">#&gt; 130  76.30568 3.388215e-05</span></span>
<span><span class="co">#&gt; 131  77.59635 1.217941e-04</span></span>
<span><span class="co">#&gt; 132  79.81484 9.534941e-04</span></span>
<span><span class="co">#&gt; 133  82.35254 8.580013e-03</span></span>
<span><span class="co">#&gt; 134  83.45274 2.010305e-02</span></span>
<span><span class="co">#&gt; 135  84.34504 3.738148e-02</span></span>
<span><span class="co">#&gt; 136  85.32178 6.703171e-02</span></span>
<span><span class="co">#&gt; 137  85.95496 9.174505e-02</span></span>
<span><span class="co">#&gt; 138  86.44606 1.124053e-01</span></span>
<span><span class="co">#&gt; 139  86.86026 1.294872e-01</span></span>
<span><span class="co">#&gt; 140  87.22753 1.432816e-01</span></span>
<span><span class="co">#&gt; 141  87.56455 1.539751e-01</span></span>
<span><span class="co">#&gt; 142  87.72517 1.581998e-01</span></span>
<span><span class="co">#&gt; 143  87.88193 1.616911e-01</span></span>
<span><span class="co">#&gt; 144  88.03570 1.644567e-01</span></span>
<span><span class="co">#&gt; 145  88.18723 1.665016e-01</span></span>
<span><span class="co">#&gt; 146  88.24737 1.671186e-01</span></span>
<span><span class="co">#&gt; 147  88.30732 1.676210e-01</span></span>
<span><span class="co">#&gt; 148  88.33723 1.678293e-01</span></span>
<span><span class="co">#&gt; 149  88.36712 1.680090e-01</span></span>
<span><span class="co">#&gt; 150  88.42679 1.682824e-01</span></span>
<span><span class="co">#&gt; 151  88.48638 1.684410e-01</span></span>
<span><span class="co">#&gt; 152  88.54595 1.684849e-01</span></span>
<span><span class="co">#&gt; 153  88.60552 1.684138e-01</span></span>
<span><span class="co">#&gt; 154  88.63531 1.683352e-01</span></span>
<span><span class="co">#&gt; 155  88.66512 1.682277e-01</span></span>
<span><span class="co">#&gt; 156  88.72482 1.679262e-01</span></span>
<span><span class="co">#&gt; 157  88.78465 1.675090e-01</span></span>
<span><span class="co">#&gt; 158  88.93505 1.659569e-01</span></span>
<span><span class="co">#&gt; 159  89.08721 1.636708e-01</span></span>
<span><span class="co">#&gt; 160  89.24185 1.606405e-01</span></span>
<span><span class="co">#&gt; 161  89.39980 1.568541e-01</span></span>
<span><span class="co">#&gt; 162  89.72959 1.469463e-01</span></span>
<span><span class="co">#&gt; 163  90.08649 1.337707e-01</span></span>
<span><span class="co">#&gt; 164  90.48591 1.170750e-01</span></span>
<span><span class="co">#&gt; 165  90.95534 9.647290e-02</span></span>
<span><span class="co">#&gt; 166  91.55409 7.133670e-02</span></span>
<span><span class="co">#&gt; 167  92.46417 4.047930e-02</span></span>
<span><span class="co">#&gt; 168  93.28246 2.207780e-02</span></span>
<span><span class="co">#&gt; 169  94.27697 9.555182e-03</span></span>
<span><span class="co">#&gt; 170  96.54041 1.066964e-03</span></span>
<span><span class="co">#&gt; 171  98.60608 1.178825e-04</span></span>
<span><span class="co">#&gt; 172 100.21223 2.008803e-05</span></span></code></pre></div>
<p>Veamos cómo resolver las inferencias a través de un ejemplo disponible en <a href="https://www.r-bloggers.com/2019/09/bayesian-linear-mixed-models-random-intercepts-slopes-and-missing-data/">R-bloggers</a>, proporcionado por <a href="https://curran.web.unc.edu/">Patrick Curran</a> y descargable desde <a href="https://github.com/MultiLevelAnalysis/Datasets-third-edition-Multilevel-book/blob/master/chapter%205/Curran/CurranLong.sav">Github</a>. Se refieren estos datos, a un estudio con 405 niños en los dos primeros años de la escuela infantil, medidos a lo largo de cuatro instantes equidistantes (no medidos todos en todos los sujetos) para registrar su progreso en lectura y en comportamiento antisocial. Nos centramos aquí exclusivamente en intentar predecir los progresos en lectura (variable <code>read</code>) a partir de su estimulación cognitiva en casa (<code>homecog</code>), teniendo en cuenta la existencia de medidas repetidas para cada sujeto (identificado como <code>id</code>) en los 4 instantes de medición (<code>occasion</code>).</p>
<p>Cargamos los datos y los inspeccionamos en la Figura <a href="anova.html#fig:curran1">3.9</a>.</p>
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># librería para leer archivos .sav</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://haven.tidyverse.org">haven</a></span><span class="op">)</span></span>
<span><span class="va">my.dir</span><span class="op">=</span><span class="st">"~/Dropbox/ESTADISTICA/BAYESIAN/VARIOS/"</span></span>
<span><span class="va">curran_dat</span> <span class="op">=</span> <span class="fu"><a href="https://haven.tidyverse.org/reference/read_spss.html">read_sav</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">my.dir</span>,<span class="st">"CurranLong.sav"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">id</span>, <span class="va">occasion</span>, <span class="va">read</span>, <span class="va">homecog</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">curran_dat</span><span class="op">$</span><span class="va">id</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">curran_dat</span><span class="op">$</span><span class="va">id</span><span class="op">)</span></span>
<span><span class="co"># 'occasion' la convertimos en factor y la preservamos como numérica en 'time'</span></span>
<span><span class="va">curran_dat</span><span class="op">$</span><span class="va">time</span><span class="op">=</span><span class="va">curran_dat</span><span class="op">$</span><span class="va">occasion</span></span>
<span><span class="va">curran_dat</span><span class="op">$</span><span class="va">occasion</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">curran_dat</span><span class="op">$</span><span class="va">occasion</span><span class="op">)</span></span>
<span><span class="co"># Relaciones</span></span>
<span><span class="va">g1</span><span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">curran_dat</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">occasion</span>,y<span class="op">=</span><span class="va">read</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">g2</span><span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">curran_dat</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">homecog</span>,y<span class="op">=</span><span class="va">read</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html">vars</a></span><span class="op">(</span><span class="va">occasion</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html">grid.arrange</a></span><span class="op">(</span><span class="va">g1</span>,<span class="va">g2</span>,ncol<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:curran1"></span>
<img src="02-anova_files/figure-html/curran1-1.png" alt="Descripción de la BD CurranLong sobre desarrollo de las habilidades lectoras en niños." width="672"><p class="caption">
Figura 3.9: Descripción de la BD CurranLong sobre desarrollo de las habilidades lectoras en niños.
</p>
</div>
<p>Como base vamos a asumir normalidad en la respuesta de un sujeto <span class="math inline">\(i\)</span> en un instante <span class="math inline">\(j\)</span>, y plantear un modelo lineal para obtener nuestras conclusiones.
<span class="math display">\[( y_{ij}|\eta_{ij},\sigma^2 ) \sim N(\eta_{ij},\sigma^2);  \ i=1,...,450; j=1,2,3,4\]</span></p>
<p>A continuación, planteamos distintas alternativas de modelización que dan lugar a diversos predictores lineales. En los primeros modelos prescindimos de momento del efecto de la estimulación cognitiva.</p>
<p><strong>M0</strong>. Solo estamos interesados en cuantificar el nivel general de habilidades lectoras, pero teniendo en cuenta posibles diferencias entre los niños. No nos interesan sin embargo, dichas diferencias. Pensamos pues en utilizar la variable <code>id</code> como efecto aleatorio y modelizar
<span class="math display">\[\eta_{ij}=\eta_i=\theta + \alpha_i^{id}\]</span>
con <span class="math inline">\(\alpha_i^{id} \sim N(0,\sigma_{\alpha}^2)\)</span> y a priori <span class="math inline">\(\tau_{\alpha} \sim Ga(0.001,0.001)\)</span>.</p>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prec.prior</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>prec<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>param<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.001</span>,<span class="fl">0.001</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">formula0</span><span class="op">=</span> <span class="va">read</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html">f</a></span><span class="op">(</span><span class="va">id</span>,model<span class="op">=</span><span class="st">"iid"</span>,hyper <span class="op">=</span> <span class="va">prec.prior</span><span class="op">)</span> </span>
<span><span class="va">fit0</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.html">inla</a></span><span class="op">(</span><span class="va">formula0</span>,family<span class="op">=</span><span class="st">"gaussian"</span>,data<span class="op">=</span><span class="va">curran_dat</span><span class="op">)</span></span>
<span><span class="va">fit</span><span class="op">=</span><span class="va">fit0</span></span>
<span><span class="va">fit</span><span class="op">$</span><span class="va">summary.fixed</span></span>
<span><span class="co">#&gt;                 mean         sd 0.025quant 0.5quant</span></span>
<span><span class="co">#&gt; (Intercept) 4.114053 0.05109301   4.013249 4.114248</span></span>
<span><span class="co">#&gt;             0.975quant mode          kld</span></span>
<span><span class="co">#&gt; (Intercept)   4.213756   NA 1.438859e-09</span></span>
<span><span class="va">fit</span><span class="op">$</span><span class="va">summary.hyperpar</span></span>
<span><span class="co">#&gt;                                              mean</span></span>
<span><span class="co">#&gt; Precision for the Gaussian observations 0.4182778</span></span>
<span><span class="co">#&gt; Precision for id                        3.7314322</span></span>
<span><span class="co">#&gt;                                                 sd</span></span>
<span><span class="co">#&gt; Precision for the Gaussian observations 0.01926771</span></span>
<span><span class="co">#&gt; Precision for id                        1.07634877</span></span>
<span><span class="co">#&gt;                                         0.025quant</span></span>
<span><span class="co">#&gt; Precision for the Gaussian observations  0.3809882</span></span>
<span><span class="co">#&gt; Precision for id                         2.1865613</span></span>
<span><span class="co">#&gt;                                          0.5quant</span></span>
<span><span class="co">#&gt; Precision for the Gaussian observations 0.4180782</span></span>
<span><span class="co">#&gt; Precision for id                        3.5402756</span></span>
<span><span class="co">#&gt;                                         0.975quant mode</span></span>
<span><span class="co">#&gt; Precision for the Gaussian observations  0.4568882   NA</span></span>
<span><span class="co">#&gt; Precision for id                         6.3678421   NA</span></span>
<span></span>
<span><span class="va">nfixed</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">marginals.fixed</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">nhyp</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">marginals.hyperpar</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">res</span><span class="op">=</span><span class="cn">NULL</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nfixed</span><span class="op">)</span><span class="op">{</span></span>
<span><span class="va">res</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">res</span>,<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">marginals.fixed</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>,</span>
<span>                         id<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">marginals.fixed</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,</span>
<span>                          tipo<span class="op">=</span><span class="st">"fixed"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nhyp</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">res</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">res</span>,<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">marginals.hyperpar</span><span class="op">[[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span>,</span>
<span>                           id<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">marginals.hyperpar</span><span class="op">)</span><span class="op">[</span><span class="va">j</span><span class="op">]</span>,</span>
<span>                            tipo<span class="op">=</span><span class="st">"prec"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">res</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x</span>,y<span class="op">=</span><span class="va">y</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>color<span class="op">=</span><span class="va">id</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html">vars</a></span><span class="op">(</span><span class="va">tipo</span><span class="op">)</span>,scales<span class="op">=</span><span class="st">"free"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position<span class="op">=</span><span class="st">"top"</span>,</span>
<span>        legend.title<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="02-anova_files/figure-html/curranm0-1.png" width="672"></div>
<p>La matriz de diseño <span class="math inline">\(Z\)</span> asociada a los efectos aleatorios se obtiene con la función <code>model.matrix</code>, y la podemos utilizar para ajustar el modelo con <code>inla</code>. Para ello habremos de definir un nuevo índice para todos los registros de la base de datos, y aplicar sobre ellos la matriz de efectos aleatorios:</p>
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Z</span> <span class="op">&lt;-</span> <span class="fu">as</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html">model.matrix</a></span><span class="op">(</span><span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">id</span>, data <span class="op">=</span> <span class="va">curran_dat</span><span class="op">)</span>, <span class="st">"Matrix"</span><span class="op">)</span></span>
<span><span class="co"># índice nuevo</span></span>
<span><span class="va">ID</span><span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">curran_dat</span><span class="op">)</span></span>
<span><span class="va">formula00</span><span class="op">=</span> <span class="va">read</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html">f</a></span><span class="op">(</span><span class="va">ID</span>,model<span class="op">=</span><span class="st">"z"</span>,Z<span class="op">=</span><span class="va">Z</span>,hyper <span class="op">=</span> <span class="va">prec.prior</span><span class="op">)</span> </span>
<span><span class="va">fit00</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.html">inla</a></span><span class="op">(</span><span class="va">formula00</span>,family<span class="op">=</span><span class="st">"gaussian"</span>,data<span class="op">=</span><span class="va">curran_dat</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in inla.model.properties.generic(inla.trim.family(model), mm[names(mm) == : Model 'z' in section 'latent' is marked as 'experimental'; changes may appear at any time.</span></span>
<span><span class="co">#&gt;   Use this model with extra care!!! Further warnings are disabled.</span></span>
<span><span class="va">fit00</span><span class="op">$</span><span class="va">summary.hyperpar</span></span>
<span><span class="co">#&gt;                                              mean</span></span>
<span><span class="co">#&gt; Precision for the Gaussian observations 0.4182685</span></span>
<span><span class="co">#&gt; Precision for ID                        3.7323155</span></span>
<span><span class="co">#&gt;                                                 sd</span></span>
<span><span class="co">#&gt; Precision for the Gaussian observations 0.01926227</span></span>
<span><span class="co">#&gt; Precision for ID                        1.07661522</span></span>
<span><span class="co">#&gt;                                         0.025quant</span></span>
<span><span class="co">#&gt; Precision for the Gaussian observations  0.3809879</span></span>
<span><span class="co">#&gt; Precision for ID                         2.1867187</span></span>
<span><span class="co">#&gt;                                          0.5quant</span></span>
<span><span class="co">#&gt; Precision for the Gaussian observations 0.4180696</span></span>
<span><span class="co">#&gt; Precision for ID                        3.5412342</span></span>
<span><span class="co">#&gt;                                         0.975quant mode</span></span>
<span><span class="co">#&gt; Precision for the Gaussian observations  0.4568666   NA</span></span>
<span><span class="co">#&gt; Precision for ID                         6.3692104   NA</span></span></code></pre></div>
<p>La diferencia entre ajustar los efectos aleatorios con “iid” o con “z” es que con la primera opción tendremos tantos efectos aleatorios como están definidos en el modelo. Sin embargo, la modelización con “z” producirá tantos efectos aleatorios como datos, con una única precisión/varianza asociada. Generalmente ambos modelos producen unas medias posterioris de los efectos aleatorios bastante parecidas.</p>
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># medias posteriori de los efectos aleatorias con model="iid"</span></span>
<span><span class="va">random0</span><span class="op">=</span><span class="va">fit0</span><span class="op">$</span><span class="va">summary.random</span><span class="op">$</span><span class="va">id</span><span class="op">$</span><span class="va">mean</span></span>
<span><span class="co"># medias posteriori de los efectos aleatorios con model="z"</span></span>
<span><span class="va">random00</span><span class="op">=</span><span class="va">fit00</span><span class="op">$</span><span class="va">summary.random</span><span class="op">$</span><span class="va">ID</span><span class="op">$</span><span class="va">mean</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">random00</span>,<span class="va">random00</span>,type<span class="op">=</span><span class="st">"l"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span><span class="op">(</span><span class="va">random0</span>,<span class="va">random0</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="02-anova_files/figure-html/curranm0b-1.png" width="672"></div>
<p><strong>M1</strong>. Dado que tenemos varias mediciones de un mismo sujeto, es razonable asumir que, por defecto, las habilidades cognitivas propias de un sujeto, <span class="math inline">\(\alpha_i^{id}\)</span>, influyen en sus habilidades lectoras.</p>
<p><span class="math display">\[\eta_{ij}=\theta + \alpha_i^{id}\]</span></p>
<p>Además, es de esperar que el tiempo que transcurre afecte de modo similar a la evolución de todos los sujetos (en la Figura <a href="anova.html#fig:curran1">3.9</a> se apreciaba cierto crecimiento). Hablamos pues de un modelo en el que predecimos las habilidades lectoras con un efecto fijo común <span class="math inline">\(\theta\)</span> afectado de cierta variación extra en función del sujeto <span class="math inline">\(i\)</span> y del instante de medición <span class="math inline">\(j\)</span>.</p>
<p><span class="math display">\[\eta_{ij}=\theta + \alpha_i^{id} + \beta_j^{oc}\]</span>
Si no nos interesa evaluar las habilidades cognitivas propias de cada sujeto, pero queremos reconocer de algún modo la variabilidad entre sujetos, <span class="math inline">\(\sigma_{\alpha}^2\)</span>, estamos pensando en unos efectos aleatorios para el sujeto, <code>id</code>, <span class="math inline">\(\alpha_i^{id} \sim N(0,\sigma_{\alpha}^2)\)</span>.</p>
<p>Si no nos interesa evaluar el efecto del tiempo sobre las habilidades lectoras, pero queremos reconocer la variabilidad entre los distintos periodos de tiempo, <span class="math inline">\(\sigma_{\beta}^2\)</span>, estamos pensando en unos efectos aleatorios asociados al tiempo, <code>occasion</code>, <span class="math inline">\(\beta_i^{oc} \sim N(0,\sigma_{\beta}^2)\)</span>.</p>
<p>Si asumimos una prior para las precisiones <span class="math inline">\(\tau_{\alpha}\)</span> y <span class="math inline">\(\tau_{\beta}\)</span> de media 1 y varianza 1000, podemos usar una <span class="math inline">\(Ga(0.001,0.001)\)</span>.</p>
<p>con
<span class="math display">\[\begin{eqnarray*}
\text{Nivel II} &amp;&amp; \\
\theta &amp;\sim &amp; N(0,100) \\
\alpha_i^{id} &amp;\sim&amp; N(0,\sigma_{\alpha}^2) \\
\beta_j^{oc} &amp;\sim&amp; N(0,\sigma_{\beta}) \\
\text{Nivel III} &amp;&amp; \\
\tau_{\alpha}=1/\sigma_{\alpha}^2 &amp;\sim&amp; Ga(0.001,0.001) \\
\tau_{\beta}=1/\sigma_{\beta}^2 &amp;\sim&amp;Ga(0.001,0.001)
\end{eqnarray*}\]</span></p>
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prec.prior</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>prec<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>param<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.001</span>,<span class="fl">0.001</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">formula1</span><span class="op">=</span> <span class="va">read</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html">f</a></span><span class="op">(</span><span class="va">id</span>,model<span class="op">=</span><span class="st">"iid"</span>,hyper <span class="op">=</span> <span class="va">prec.prior</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html">f</a></span><span class="op">(</span><span class="va">occasion</span>,model<span class="op">=</span><span class="st">"iid"</span>,hyper <span class="op">=</span> <span class="va">prec.prior</span><span class="op">)</span></span>
<span><span class="va">fit1</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.html">inla</a></span><span class="op">(</span><span class="va">formula1</span>,family<span class="op">=</span><span class="st">"gaussian"</span>,data<span class="op">=</span><span class="va">curran_dat</span><span class="op">)</span></span>
<span><span class="va">fit</span><span class="op">=</span><span class="va">fit1</span></span>
<span><span class="va">fit</span><span class="op">$</span><span class="va">summary.fixed</span></span>
<span><span class="co">#&gt;                 mean        sd 0.025quant 0.5quant</span></span>
<span><span class="co">#&gt; (Intercept) 4.353284 0.5190379   3.331329 4.353276</span></span>
<span><span class="co">#&gt;             0.975quant mode          kld</span></span>
<span><span class="co">#&gt; (Intercept)   5.375282   NA 6.134191e-09</span></span>
<span><span class="va">fit</span><span class="op">$</span><span class="va">summary.hyperpar</span></span>
<span><span class="co">#&gt;                                             mean        sd</span></span>
<span><span class="co">#&gt; Precision for the Gaussian observations 2.460748 0.1149805</span></span>
<span><span class="co">#&gt; Precision for id                        1.268488 0.1052648</span></span>
<span><span class="co">#&gt; Precision for occasion                  1.071191 0.1873051</span></span>
<span><span class="co">#&gt;                                         0.025quant 0.5quant</span></span>
<span><span class="co">#&gt; Precision for the Gaussian observations   2.238362 2.459519</span></span>
<span><span class="co">#&gt; Precision for id                          1.073052 1.264437</span></span>
<span><span class="co">#&gt; Precision for occasion                    0.816554 1.032870</span></span>
<span><span class="co">#&gt;                                         0.975quant mode</span></span>
<span><span class="co">#&gt; Precision for the Gaussian observations   2.691216   NA</span></span>
<span><span class="co">#&gt; Precision for id                          1.487495   NA</span></span>
<span><span class="co">#&gt; Precision for occasion                    1.531415   NA</span></span>
<span></span>
<span><span class="va">nfixed</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">marginals.fixed</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">nhyp</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">marginals.hyperpar</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">res</span><span class="op">=</span><span class="cn">NULL</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nfixed</span><span class="op">)</span><span class="op">{</span></span>
<span><span class="va">res</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">res</span>,<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">marginals.fixed</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>,</span>
<span>                         id<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">marginals.fixed</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,</span>
<span>                          tipo<span class="op">=</span><span class="st">"fixed"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nhyp</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">res</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">res</span>,<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">marginals.hyperpar</span><span class="op">[[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span>,</span>
<span>                           id<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">marginals.hyperpar</span><span class="op">)</span><span class="op">[</span><span class="va">j</span><span class="op">]</span>,</span>
<span>                            tipo<span class="op">=</span><span class="st">"prec"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">res</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x</span>,y<span class="op">=</span><span class="va">y</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>color<span class="op">=</span><span class="va">id</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html">vars</a></span><span class="op">(</span><span class="va">tipo</span><span class="op">)</span>,scales<span class="op">=</span><span class="st">"free"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position<span class="op">=</span><span class="st">"top"</span>,</span>
<span>        legend.title<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="02-anova_files/figure-html/curran2-1.png" width="672"></div>
<ul>
<li>
<strong>M2</strong>. Por otro lado, y en base a la Figura <a href="anova.html#fig:curran3">3.10</a> podríamos considerar el efecto del tiempo que transcurre desde el inicio del estudio (<code>t=time</code>), como una covariable numérica que afecta de modo lineal a las habilidades lectoras.</li>
</ul>
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">curran_dat</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">occasion</span>,y<span class="op">=</span><span class="va">read</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>group<span class="op">=</span><span class="va">id</span><span class="op">)</span>,color<span class="op">=</span><span class="st">"grey"</span>,size<span class="op">=</span><span class="fl">0.4</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:curran3"></span>
<img src="02-anova_files/figure-html/curran3-1.png" alt="Relación entre el tiempo y las habilidades lectoras para cada sujeto (líneas)." width="672"><p class="caption">
Figura 3.10: Relación entre el tiempo y las habilidades lectoras para cada sujeto (líneas).
</p>
</div>
<p>Podríamos seguir planteando un efecto aleatorio del sujeto sobre sus resultados lectores, y un efecto fijo asociado al tiempo transcurrido hasta el instante <span class="math inline">\(t_j=j\)</span>, esto es, una interceptación aleatoria y una pendiente fija.</p>
<p><span class="math display">\[\eta_{ij}=\theta + \alpha_i^{id} + \beta \cdot t_j \]</span>
con
<span class="math display">\[\begin{eqnarray*}
\text{Nivel II} &amp;&amp; \\
\theta &amp;\sim &amp; N(0,100) \\
\beta &amp;\sim&amp; N(0,100) \\
\alpha_i^{id} &amp;\sim&amp; N(0,\sigma_{\alpha}^2) \\
\text{Nivel III} &amp;&amp; \\
\tau_{\alpha}=1/\sigma_{\alpha}^2 &amp;\sim&amp; Ga(0.001,0.001)
\end{eqnarray*}\]</span></p>
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prec.prior</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>prec<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>param<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.001</span>,<span class="fl">0.001</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">formula2</span><span class="op">=</span> <span class="va">read</span> <span class="op">~</span> <span class="va">time</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html">f</a></span><span class="op">(</span><span class="va">id</span>,model<span class="op">=</span><span class="st">"iid"</span>,hyper <span class="op">=</span> <span class="va">prec.prior</span><span class="op">)</span> </span>
<span><span class="va">fit2</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.html">inla</a></span><span class="op">(</span><span class="va">formula2</span>,family<span class="op">=</span><span class="st">"gaussian"</span>,data<span class="op">=</span><span class="va">curran_dat</span><span class="op">)</span></span>
<span><span class="va">fit</span><span class="op">=</span><span class="va">fit2</span></span>
<span><span class="va">fit</span><span class="op">$</span><span class="va">summary.fixed</span></span>
<span><span class="co">#&gt;                 mean         sd 0.025quant 0.5quant</span></span>
<span><span class="co">#&gt; (Intercept) 2.703744 0.05265809   2.600420 2.703750</span></span>
<span><span class="co">#&gt; time        1.101341 0.01758955   1.066828 1.101345</span></span>
<span><span class="co">#&gt;             0.975quant mode          kld</span></span>
<span><span class="co">#&gt; (Intercept)   2.807034   NA 1.209173e-11</span></span>
<span><span class="co">#&gt; time          1.135834   NA 5.382594e-12</span></span>
<span><span class="va">fit</span><span class="op">$</span><span class="va">summary.hyperpar</span></span>
<span><span class="co">#&gt;                                             mean        sd</span></span>
<span><span class="co">#&gt; Precision for the Gaussian observations 2.174500 0.1013860</span></span>
<span><span class="co">#&gt; Precision for id                        1.285657 0.1091145</span></span>
<span><span class="co">#&gt;                                         0.025quant 0.5quant</span></span>
<span><span class="co">#&gt; Precision for the Gaussian observations   1.980313 2.172656</span></span>
<span><span class="co">#&gt; Precision for id                          1.083335 1.281368</span></span>
<span><span class="co">#&gt;                                         0.975quant mode</span></span>
<span><span class="co">#&gt; Precision for the Gaussian observations   2.379694   NA</span></span>
<span><span class="co">#&gt; Precision for id                          1.512945   NA</span></span>
<span></span>
<span><span class="va">nfixed</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">marginals.fixed</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">nhyp</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">marginals.hyperpar</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">res</span><span class="op">=</span><span class="cn">NULL</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nfixed</span><span class="op">)</span><span class="op">{</span></span>
<span><span class="va">res</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">res</span>,<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">marginals.fixed</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>,</span>
<span>                         id<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">marginals.fixed</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,</span>
<span>                          tipo<span class="op">=</span><span class="st">"fixed"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nhyp</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">res</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">res</span>,<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">marginals.hyperpar</span><span class="op">[[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span>,</span>
<span>                         id<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">marginals.hyperpar</span><span class="op">)</span><span class="op">[</span><span class="va">j</span><span class="op">]</span>,</span>
<span>                          tipo<span class="op">=</span><span class="st">"prec"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">res</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x</span>,y<span class="op">=</span><span class="va">y</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>color<span class="op">=</span><span class="va">id</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html">vars</a></span><span class="op">(</span><span class="va">tipo</span><span class="op">)</span>,scales<span class="op">=</span><span class="st">"free"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position<span class="op">=</span><span class="st">"top"</span>,</span>
<span>        legend.title<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="02-anova_files/figure-html/curran4-1.png" width="672"></div>
<ul>
<li>
<strong>M3</strong>. Siendo más estrictos al mirar la Figura <a href="anova.html#fig:curran3">3.10</a>, podríamos pensar que, además de tener diferentes orígenes en las habilidades lectoras para cada sujeto (interceptaciones distintas), dado el efecto lineal ascendente del tiempo sobre las habilidades lectoras de los sujetos, no todos los sujetos evolucionan al mismo ritmo, esto es, no todas las rectas son paralelas. Tendríamos entonces efectos aleatorios asociados a los sujetos, y vinculados a las interceptaciones y a las pendientes de las rectas.</li>
</ul>
<p><span class="math display">\[\eta_{ij}=\theta + \alpha_i^{id} + \beta \cdot t_j + \beta_{ij}\]</span></p>
<p>con
<span class="math display">\[\begin{eqnarray*}
\text{Nivel II} &amp;&amp; \\
\theta &amp;\sim &amp; N(0,100) \\
\beta &amp;\sim&amp; N(0,100) \\
\alpha_i^{id} &amp;\sim&amp; N(0,\sigma_{\alpha}^2) \\
\beta_{ij} &amp;\sim &amp; N(0,\sigma_{j})^2 \\
\text{Nivel III} &amp;&amp; \\
\tau_{\alpha}=1/\sigma_{\alpha}^2 &amp;\sim&amp; Ga(0.001,0.001) \\
\tau_{j}=1/\sigma_{j}^2 &amp;\sim&amp;Ga(0.001,0.001)
\end{eqnarray*}\]</span></p>
<p>Además, dado que no disponemos de todas las mediciones temporales para todos los sujetos, tendremos que la variable tiempo (<code>time</code>) está anidada en la variable <code>id</code>. Este efecto de anidación que nos va a reportar la variabilidad que hay entre las pendientes distintas de los sujetos para cada instante de tiempo.</p>
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prec.prior</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>prec<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>param<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.001</span>,<span class="fl">0.001</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">Z</span> <span class="op">&lt;-</span> <span class="fu">as</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html">model.matrix</a></span><span class="op">(</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">id</span><span class="op">:</span><span class="va">time</span>, data <span class="op">=</span> <span class="va">curran_dat</span><span class="op">)</span>, <span class="st">"Matrix"</span><span class="op">)</span></span>
<span><span class="va">ID</span><span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">curran_dat</span><span class="op">)</span></span>
<span><span class="va">formula3</span><span class="op">=</span> <span class="va">read</span> <span class="op">~</span> <span class="va">time</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html">f</a></span><span class="op">(</span><span class="va">id</span>,model<span class="op">=</span><span class="st">"iid"</span>,hyper<span class="op">=</span><span class="va">prec.prior</span><span class="op">)</span><span class="op">+</span></span>
<span>                        <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html">f</a></span><span class="op">(</span><span class="va">ID</span>,model<span class="op">=</span><span class="st">"z"</span>,Z<span class="op">=</span><span class="va">Z</span>,hyper <span class="op">=</span> <span class="va">prec.prior</span><span class="op">)</span> </span>
<span><span class="va">fit3</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.html">inla</a></span><span class="op">(</span><span class="va">formula3</span>,family<span class="op">=</span><span class="st">"gaussian"</span>,data<span class="op">=</span><span class="va">curran_dat</span><span class="op">)</span></span>
<span><span class="va">fit</span><span class="op">=</span><span class="va">fit3</span></span>
<span><span class="va">fit</span><span class="op">$</span><span class="va">summary.fixed</span></span>
<span><span class="co">#&gt;                mean         sd 0.025quant 0.5quant</span></span>
<span><span class="co">#&gt; (Intercept) 2.69572 0.04698051   2.603549 2.695717</span></span>
<span><span class="co">#&gt; time        1.12016 0.02266314   1.075907 1.120082</span></span>
<span><span class="co">#&gt;             0.975quant mode          kld</span></span>
<span><span class="co">#&gt; (Intercept)   2.787906   NA 4.014028e-11</span></span>
<span><span class="co">#&gt; time          1.164852   NA 1.199685e-09</span></span>
<span><span class="va">fit</span><span class="op">$</span><span class="va">summary.hyperpar</span></span>
<span><span class="co">#&gt;                                              mean        sd</span></span>
<span><span class="co">#&gt; Precision for the Gaussian observations  3.014885 0.1685192</span></span>
<span><span class="co">#&gt; Precision for id                         1.564201 0.1431432</span></span>
<span><span class="co">#&gt; Precision for ID                        11.406525 1.7110556</span></span>
<span><span class="co">#&gt;                                         0.025quant</span></span>
<span><span class="co">#&gt; Precision for the Gaussian observations   2.695040</span></span>
<span><span class="co">#&gt; Precision for id                          1.301279</span></span>
<span><span class="co">#&gt; Precision for ID                          8.451643</span></span>
<span><span class="co">#&gt;                                          0.5quant</span></span>
<span><span class="co">#&gt; Precision for the Gaussian observations  3.010785</span></span>
<span><span class="co">#&gt; Precision for id                         1.557670</span></span>
<span><span class="co">#&gt; Precision for ID                        11.263319</span></span>
<span><span class="co">#&gt;                                         0.975quant mode</span></span>
<span><span class="co">#&gt; Precision for the Gaussian observations   3.358807   NA</span></span>
<span><span class="co">#&gt; Precision for id                          1.864766   NA</span></span>
<span><span class="co">#&gt; Precision for ID                         15.177077   NA</span></span>
<span></span>
<span><span class="va">nfixed</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">marginals.fixed</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">nhyp</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">marginals.hyperpar</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">res</span><span class="op">=</span><span class="cn">NULL</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nfixed</span><span class="op">)</span><span class="op">{</span></span>
<span><span class="va">res</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">res</span>,<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">marginals.fixed</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>,</span>
<span>                         id<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">marginals.fixed</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,</span>
<span>                          tipo<span class="op">=</span><span class="st">"fixed"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nhyp</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">res</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">res</span>,<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">marginals.hyperpar</span><span class="op">[[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span>,</span>
<span>                         id<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">marginals.hyperpar</span><span class="op">)</span><span class="op">[</span><span class="va">j</span><span class="op">]</span>,</span>
<span>                          tipo<span class="op">=</span><span class="st">"prec"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">res</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x</span>,y<span class="op">=</span><span class="va">y</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>color<span class="op">=</span><span class="va">id</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html">vars</a></span><span class="op">(</span><span class="va">tipo</span><span class="op">)</span>,scales<span class="op">=</span><span class="st">"free"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position<span class="op">=</span><span class="st">"top"</span>,</span>
<span>        legend.title<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="02-anova_files/figure-html/curran5-1.png" width="672"></div>

</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="inlabasics.html"><span class="header-section-number">2</span> Regresión lineal</a></div>
<div class="next"><a href="glm.html"><span class="header-section-number">4</span> Modelos lineales generalizados</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#anova"><span class="header-section-number">3</span> Modelo de ANOVA</a></li>
<li><a class="nav-link" href="#introducci%C3%B3n-1"><span class="header-section-number">3.1</span> Introducción</a></li>
<li><a class="nav-link" href="#el-modelo-de-anova"><span class="header-section-number">3.2</span> El modelo de ANOVA</a></li>
<li><a class="nav-link" href="#anova-de-una-v%C3%ADa"><span class="header-section-number">3.3</span> Anova de una vía</a></li>
<li><a class="nav-link" href="#anova-de-varias-v%C3%ADas"><span class="header-section-number">3.4</span> Anova de varias vías</a></li>
<li><a class="nav-link" href="#an%C3%A1lisis-de-ancova"><span class="header-section-number">3.5</span> Análisis de ANCOVA</a></li>
<li><a class="nav-link" href="#efectos-aleatorios"><span class="header-section-number">3.6</span> Efectos aleatorios</a></li>
<li><a class="nav-link" href="#modelos-mixtos"><span class="header-section-number">3.7</span> Modelos mixtos</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
          
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Una primera aproximación a la Estadística Bayesiana</strong>" was written by true, true. It was last built on 2022-11-03.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
